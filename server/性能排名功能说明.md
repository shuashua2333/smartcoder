# 🏆 性能排名功能说明

## 📋 功能概述

后端已升级为支持类似 LeetCode 的性能排名功能，可以计算每次提交击败了多少百分比的历史提交。

## ✨ 功能特点

1. **提交历史存储**：所有提交记录保存在内存数组中
2. **自动计算排名**：每次提交后自动计算击败率
3. **双维度排名**：
   - **运行时间（Runtime）**：值越小越好，击败了运行时间更长的提交
   - **内存使用（Memory）**：值越小越好，击败了内存使用更多的提交

## 🔧 技术实现

### 1. 数据结构变更

**之前：**
```javascript
let latestSubmission = null;  // 只保存最后一次提交
```

**现在：**
```javascript
let submissions = [];  // 保存所有提交记录
```

### 2. 击败率计算算法

```javascript
function calculateBeatPercentage(value, allValues, isBetterLower = true)
```

**工作原理：**
- 过滤掉无效值（-1 表示失败的提交）
- 计算当前值击败了多少个历史值
- 返回百分比（0-100）

**示例：**
- 历史提交的运行时间：[100ms, 150ms, 200ms, 300ms]
- 当前提交：120ms
- 击败了：[150ms, 200ms, 300ms] = 3个
- 击败率：3/4 = 75%

### 3. API 接口

#### POST `/api/submit`

**请求体：**
```json
{
  "code": "用户代码",
  "problemId": "题目ID",
  "output": "程序输出",
  "runtime": 120,  // 运行时间（毫秒）
  "memory": 1024,  // 内存使用（字节）
  "timestamp": 1234567890
}
```

**响应：**
```json
{
  "message": "提交成功，云端已接收",
  "beatRuntimePct": 75,  // 运行时间击败率
  "beatMemoryPct": 60    // 内存使用击败率
}
```

#### GET `/api/check`

**响应：**
```json
{
  "code": "用户代码",
  "problemId": "题目ID",
  "output": "程序输出",
  "runtime": 120,
  "memory": 1024,
  "timestamp": 1234567890,
  "status": "pending",
  "beatRuntimePct": 75,  // 新增：运行时间击败率
  "beatMemoryPct": 60    // 新增：内存使用击败率
}
```

## 📊 前端显示

网页端会显示：
- ⚡ **性能评测结果**
  - 运行时间: 120ms 🏆 **击败了 75% 的用户**
  - 内存使用: 1.00KB 🏆 **击败了 60% 的用户**

## 🎯 使用场景

1. **第一次提交**：
   - 击败率：null（没有历史数据对比）
   - 显示：只显示性能数据，不显示击败率

2. **第二次提交**：
   - 如果运行时间更快 → 击败率：100%（击败了之前的提交）
   - 如果运行时间更慢 → 击败率：0%（没有击败任何提交）

3. **多次提交后**：
   - 击败率会动态计算，显示相对于所有历史提交的排名

## 📈 排名逻辑

### 运行时间（Runtime）

- **越小越好**：运行时间越短，性能越好
- **击败逻辑**：如果当前运行时间是 100ms，历史提交中有 3 个提交的运行时间 > 100ms，则击败了这 3 个提交

### 内存使用（Memory）

- **越小越好**：内存使用越少，性能越好
- **击败逻辑**：如果当前内存使用是 1024 bytes，历史提交中有 2 个提交的内存使用 > 1024 bytes，则击败了这 2 个提交

## ⚠️ 注意事项

1. **无效数据**：
   - 如果 `runtime` 或 `memory` 为 -1（表示失败），不会参与排名计算
   - 击败率会显示为 `null`

2. **内存存储**：
   - 所有数据存储在内存中
   - 服务器重启后数据会清空
   - 适合演示和开发环境

3. **性能考虑**：
   - 每次提交都会遍历所有历史记录计算排名
   - 如果提交数很大（>10000），可能需要优化

## 🔮 未来改进

- [ ] 按题目ID分组计算排名（不同题目的提交分开排名）
- [ ] 添加数据库持久化存储
- [ ] 添加排行榜 API
- [ ] 支持按日期筛选历史记录
- [ ] 添加性能趋势图表

## 📝 示例

### 示例 1：第一次提交

**提交数据：**
- runtime: 150ms
- memory: 2048 bytes

**结果：**
- beatRuntimePct: null（没有历史数据）
- beatMemoryPct: null（没有历史数据）

### 示例 2：第二次提交（更快）

**历史：** runtime: 150ms
**当前：** runtime: 100ms

**结果：**
- beatRuntimePct: 100%（击败了之前的 150ms 提交）

### 示例 3：第三次提交（中等）

**历史：** runtime: [150ms, 100ms]
**当前：** runtime: 120ms

**结果：**
- beatRuntimePct: 50%（击败了 150ms，但被 100ms 击败）

