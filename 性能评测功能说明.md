# ⚡ 本地代码运行和性能评测功能

## 📋 功能概述

已为 SmartCoder 扩展添加了类似 LeetCode 的本地代码运行和性能评测功能。

## ✨ 功能特点

1. **本地代码运行**：在提交到云端前，先在本地运行代码
2. **性能评测**：
   - **运行时间**（Runtime）：使用 C# `Stopwatch` 测量
   - **内存使用**（Memory）：使用 `GC.GetTotalMemory` 测量
3. **自动代码包装**：智能检测用户代码是否包含 `Main` 方法，自动包装性能监控代码
4. **错误处理**：完善的错误捕获和报告

## 🔧 技术实现

### 1. 核心方法：`_runCodeLocally`

```typescript
private async _runCodeLocally(code: string): Promise<{ output: string; runtime: number; memory: number } | null>
```

**工作流程：**

1. **创建临时项目**：在系统临时目录下创建临时的 .NET 项目
2. **代码包装**：
   - 如果代码已有 `Main` 方法：在方法内部注入性能监控代码
   - 如果代码没有 `Main` 方法：创建完整的 `Main` 方法包装
3. **运行代码**：使用 `dotnet run` 执行代码
4. **解析输出**：从输出中提取性能数据（使用特殊标记 `===SMARTCODER_PERF_START===`）
5. **清理**：自动删除临时目录

### 2. 性能监控代码注入

代码会在用户代码执行前后添加：

```csharp
var sw = Stopwatch.StartNew();
long memoryBefore = GC.GetTotalMemory(false);

// ... 用户代码 ...

sw.Stop();
long memoryAfter = GC.GetTotalMemory(false);
long memoryUsed = Math.Max(0, memoryAfter - memoryBefore);
Console.WriteLine("===SMARTCODER_PERF_START===");
Console.WriteLine($"RUNTIME_MS:{sw.ElapsedMilliseconds}");
Console.WriteLine($"MEMORY_BYTES:{memoryUsed}");
Console.WriteLine("===SMARTCODER_PERF_END===");
```

### 3. 数据流

```
VS Code 编辑器代码
    ↓
_runCodeLocally (本地运行)
    ↓
性能数据 { output, runtime, memory }
    ↓
_submitToCloud (提交到云端)
    ↓
后端服务器 /api/submit
    ↓
网页端显示性能数据和 AI 反馈
```

## 📦 更新的文件

### 1. `src/extension.ts`

- ✅ 添加 `_runCodeLocally` 方法
- ✅ 修改 `_submitToCloud` 方法，集成性能评测
- ✅ 添加必要的导入：`fs`, `os`, `child_process`

### 2. `server/server.js`

- ✅ 更新 `/api/submit` 接口，接收 `output`, `runtime`, `memory` 字段
- ✅ 在控制台输出性能数据日志

### 3. `index.html`

- ✅ 更新 `handleNewSubmission` 函数，显示性能数据
- ✅ AI 反馈中包含性能分析建议

## 🚀 使用流程

1. **用户在 VS Code 中编写代码**
2. **点击"☁️ 提交到网页端"按钮**
3. **扩展自动执行：**
   - 显示 "⚡ 正在本地运行代码并评测性能..."
   - 创建临时项目并运行代码
   - 解析性能数据
   - 显示性能数据（运行时间、内存使用）
4. **提交到云端**：代码和性能数据一起发送到后端
5. **网页端显示**：AI 导师会根据代码和性能数据给出反馈

## ⚙️ 环境要求

### 必需

- **.NET SDK**：需要在系统上安装 .NET SDK（版本 6.0 或更高）
  - 检查：运行 `dotnet --version`
  - 下载：https://dotnet.microsoft.com/download

### 可选

- 如果未安装 .NET SDK，代码会返回错误信息，但不影响其他功能

## 🐛 错误处理

- **代码运行失败**：返回错误输出，`runtime` 和 `memory` 设为 `-1`
- **.NET SDK 未安装**：捕获错误并提示用户安装
- **超时保护**：30 秒超时限制，防止无限循环
- **临时目录清理**：即使出错也会尝试清理临时文件

## 📊 性能数据格式

```json
{
  "output": "程序的标准输出",
  "runtime": 123,  // 运行时间（毫秒），-1 表示失败
  "memory": 1024   // 内存使用（字节），-1 表示失败
}
```

## 💡 注意事项

1. **代码包装限制**：
   - 如果用户代码包含 `Main` 方法，会在方法内部注入监控代码
   - 复杂嵌套的 `Main` 方法可能无法正确包装
   - 建议用户只写核心逻辑，不要包含 `Main` 方法

2. **性能测量精度**：
   - 运行时间精度：毫秒级
   - 内存测量：包含 GC 开销，可能不完全准确

3. **临时目录**：
   - 使用系统临时目录
   - 自动清理，但异常情况下可能需要手动清理

4. **安全性**：
   - 代码在本地运行，有 30 秒超时限制
   - 只运行控制台程序，不执行其他危险操作

## 🔮 未来改进

- [ ] 支持更多编程语言（Python, JavaScript 等）
- [ ] 支持测试用例自动运行
- [ ] 性能数据可视化图表
- [ ] 代码复杂度分析
- [ ] 多线程性能测试

