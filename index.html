<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCoder æ™ºèƒ½æ•™å­¦å¹³å°</title>
    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Markdown & Code Highlighting Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Split.js åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.0/split.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid #0078d4;
        }
        
        h1 { 
            color: #0078d4; 
            font-size: 24px;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        #leftTopContainer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        /* Split.js æ‹–æ‹½æ¡æ ·å¼ */
        .gutter {
            background-color: #e0e0e0;
            background-repeat: no-repeat;
            background-position: 50%;
            transition: background-color 0.3s;
        }
        .gutter:hover {
            background-color: #0078d4;
        }
        .gutter.gutter-horizontal {
            cursor: col-resize;
            width: 10px;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
        }
        .gutter.gutter-vertical {
            cursor: row-resize;
            height: 10px;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAFAQMAAABoV865AAAABlBMVEVHcEzMzMzyAv2sAAAAAXRSTlMAQObYZgAAABBJREFUeF5jOAMEEAIEEFwAn3kMwcB6I2AAAAAASUVORK5CYII=');
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card h2 { 
            margin-bottom: 15px; 
            color: #0078d4;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* çŸ¥è¯†ç‚¹è¾“å…¥åŒº */
        .knowledge-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .knowledge-input-area input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .knowledge-input-area input:focus {
            border-color: #0078d4;
        }

        .knowledge-input-area button {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .knowledge-input-area button:hover {
            background: #005a9e;
        }

        .knowledge-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* é¢˜ç›®å¡ç‰‡ */
        .problem-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .problem-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .problem-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .problem-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .problem-description {
            line-height: 1.6;
            color: #444;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .problem-footer {
            flex-shrink: 0;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .problem-actions {
            display: flex;
            gap: 10px;
        }

        button { 
            background: #0078d4; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: 0.3s; 
        }
        button:hover { background: #005a9e; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .status-bar { 
            margin-top: 10px; 
            padding: 10px; 
            border-radius: 4px; 
            background: #e0e0e0; 
            font-size: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #ccc; 
            display: inline-block; 
            margin-right: 5px; 
        }
        .dot.active { 
            background: #28a745; 
            box-shadow: 0 0 5px #28a745; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user {
            background: #0078d4;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            align-self: flex-start;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            align-self: center;
            max-width: 90%;
            font-size: 12px;
        }

        /* === Markdown & Code Block Styling === */
        .message pre {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .message code {
            background: rgba(0, 0, 0, 0.1);
            color: #d4d4d4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        .message pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            color: inherit;
        }

        .message p {
            margin: 8px 0;
        }

        .message p:first-child {
            margin-top: 0;
        }

        .message p:last-child {
            margin-bottom: 0;
        }

        .message ul, .message ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message li {
            margin: 4px 0;
        }

        .message h1, .message h2, .message h3 {
            margin: 12px 0 8px 0;
            font-weight: 600;
        }

        .message h1 { font-size: 18px; }
        .message h2 { font-size: 16px; }
        .message h3 { font-size: 14px; }

        .message blockquote {
            border-left: 3px solid #ffc107;
            padding-left: 12px;
            margin: 8px 0;
            color: #666;
        }

        .message table {
            border-collapse: collapse;
            margin: 8px 0;
            width: 100%;
        }

        .message table th,
        .message table td {
            border: 1px solid #ddd;
            padding: 6px 12px;
            text-align: left;
        }

        .message table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .message strong {
            font-weight: 600;
        }

        .message em {
            font-style: italic;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: border-color 0.3s;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input-area textarea:focus {
            border-color: #0078d4;
        }

        .chat-input-area button {
            padding: 10px 20px;
            align-self: flex-end;
        }

        /* âœ¨ æ¨¡å‹åˆ‡æ¢åŒºåŸŸæ ·å¼ */
        .model-switch {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .model-switch input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .model-switch label {
            cursor: pointer;
            user-select: none;
            color: #333;
        }

        /* ä»£ç é¢„è§ˆ */
        .code-preview { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 12px; 
            max-height: 150px; 
            overflow: auto; 
            margin-top: 10px; 
            display: none;
            border: 1px solid #333;
        }

        .loading {
            color: #0078d4;
            font-style: italic;
        }

        /* LeetCode é£æ ¼çš„ç»“æœå±•ç¤º */
        .result-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
            max-height: 30vh;
            overflow-y: auto;
        }

        .result-banner {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-banner.accepted {
            background: #0d5635;
            color: #4ade80;
            border: 1px solid #22c55e;
        }

        .result-banner.error {
            background: #7f1d1d;
            color: #f87171;
            border: 1px solid #ef4444;
        }

        .metrics-container {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            padding: 12px;
            background: #252526;
            border-radius: 6px;
        }

        .metric-item {
            flex: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #858585;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .metric-unit {
            font-size: 14px;
            color: #858585;
            margin-left: 4px;
        }

        .beat-percentage {
            font-size: 12px;
            color: #4ade80;
            margin-top: 4px;
        }

        .charts-row {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }

        .chart-container {
            flex: 1;
            background: #252526;
            border-radius: 6px;
            padding: 15px;
            min-width: 0; /* ç¡®ä¿ flex å­å…ƒç´ å¯ä»¥æ­£ç¡®æ”¶ç¼© */
        }

        .chart-title {
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* âœ¨ å¤æ‚åº¦åˆ†æå¡ç‰‡æ ·å¼ */
        .complexity-card {
            margin-bottom: 15px;
        }

        .complexity-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .complexity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #0078d4;
        }

        .complexity-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .complexity-value {
            font-size: 18px;
            font-weight: 600;
            color: #0078d4;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .complexity-explanation {
            padding: 12px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
            color: #856404;
        }

        #runtimeChart, #memoryChart {
            width: 100% !important;
            height: 300px !important;
            min-width: 0;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
            .metrics-container {
                flex-direction: column;
                gap: 15px;
            }
            .charts-row {
                flex-direction: column;
            }
            .result-container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ SmartCoder æ™ºèƒ½ç¼–ç¨‹æ•™å­¦å¹³å°</h1>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ï¼šé¢˜ç›®åŒº -->
        <div class="left-panel" id="leftPanel">
            <!-- ä¸Šæ–¹åŒºåŸŸï¼šçŸ¥è¯†ç‚¹å’Œé¢˜åº“ -->
            <div id="leftTopContainer" style="display: flex; flex-direction: column; gap: 15px; overflow: hidden;">
                <!-- çŸ¥è¯†ç‚¹è¾“å…¥å¡ç‰‡ -->
                <div class="card" id="knowledgeCard">
                    <h2>ğŸ“š æˆ‘æƒ³å­¦ä¹ </h2>
                    <div class="knowledge-input-area">
                        <input 
                            type="text" 
                            id="knowledgeInput" 
                            placeholder="è¾“å…¥çŸ¥è¯†ç‚¹æˆ–æƒ³å­¦çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ•°ç»„ã€æ’åºç®—æ³•ã€åŠ¨æ€è§„åˆ’..."
                            onkeypress="if(event.key==='Enter') generateProblem()"
                        />
                        <button id="generateBtn" onclick="generateProblem()">ğŸ² AI å‡ºé¢˜</button>
                    </div>
                </div>

                <!-- æœ¬åœ°é¢˜åº“åˆ—è¡¨ -->
                <div class="card">
                    <h2>ğŸ“š æœ¬åœ°é¢˜åº“</h2>
                    <div id="problemsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="padding: 10px; color: #666; text-align: center;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- é¢˜ç›®å¡ç‰‡ -->
            <div class="card problem-card" id="problemCard">
                <div class="problem-content">
                    <div class="problem-title" id="problemTitle">ç­‰å¾…å‡ºé¢˜...</div>
                    <div class="problem-id" id="problemId"></div>
                    <div class="problem-description" id="problemDescription">
                        è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œç„¶åç‚¹å‡»"AI å‡ºé¢˜"æŒ‰é’®ï¼ŒAI ä¼šä¸ºä½ ç”Ÿæˆç›¸åº”çš„ç¼–ç¨‹é¢˜ç›®ã€‚
                    </div>
                </div>
                
                <div class="problem-footer">
                    <!-- âœ¨ å¤æ‚åº¦åˆ†æå¡ç‰‡ -->
                    <div class="complexity-card" id="complexityCard" style="display: none; margin-bottom: 15px;">
                        <h2 style="margin-bottom: 15px; color: #0078d4; font-size: 18px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">ğŸ“Š å¤æ‚åº¦åˆ†æ</h2>
                        <div class="complexity-content">
                            <div class="complexity-item">
                                <div class="complexity-label">æ—¶é—´å¤æ‚åº¦</div>
                                <div class="complexity-value" id="timeComplexity">-</div>
                            </div>
                            <div class="complexity-item">
                                <div class="complexity-label">ç©ºé—´å¤æ‚åº¦</div>
                                <div class="complexity-value" id="spaceComplexity">-</div>
                            </div>
                            <div class="complexity-explanation" id="complexityExplanation"></div>
                        </div>
                    </div>
                    
                    <div class="problem-actions">
                        <button id="openVsCodeBtn" onclick="openVsCode()" disabled>ğŸš€ åœ¨ VS Code ä¸­ç¼–ç¨‹</button>
                        <button onclick="generateProblem()">ğŸ”„ æ¢ä¸€é¢˜</button>
                    </div>
                    <div class="status-bar">
                        <span><span id="sync-dot" class="dot"></span> äº‘ç«¯åŒæ­¥</span>
                        <span id="last-update">ç­‰å¾…è¿æ¥...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç»“æœå±•ç¤ºå’Œ AI äº’åŠ¨åŒº -->
        <div class="right-panel" id="rightPanel">
            <!-- LeetCode é£æ ¼çš„ç»“æœå±•ç¤º -->
            <div class="card result-container" id="resultContainer">
                <div class="result-banner accepted" id="resultBanner">
                    <span>âœ“</span>
                    <span>Accepted</span>
                </div>

                <div class="metrics-container">
                    <div class="metric-item">
                        <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                        <div class="metric-value">
                            <span id="runtimeValue">0</span>
                            <span class="metric-unit">ms</span>
                        </div>
                        <div class="beat-percentage" id="runtimeBeatPct"></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å†…å­˜æ¶ˆè€—</div>
                        <div class="metric-value">
                            <span id="memoryValue">0</span>
                            <span class="metric-unit">MB</span>
                        </div>
                        <div class="beat-percentage" id="memoryBeatPct"></div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <div class="chart-title">è¿è¡Œæ—¶é—´è¶‹åŠ¿</div>
                        <div id="runtimeChart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">å†…å­˜ä½¿ç”¨è¶‹åŠ¿</div>
                        <div id="memoryChart"></div>
                    </div>
                </div>
            </div>

            <div class="card chat-area">
                <h2>ğŸ’¬ AI æ•™å­¦åŠ©æ‰‹</h2>
                
                <!-- âœ¨ æ¨¡å‹åˆ‡æ¢åŒºåŸŸ -->
                <div class="model-switch">
                    <input type="checkbox" id="useLocalModel">
                    <label for="useLocalModel">ä½¿ç”¨æœ¬åœ° Ollama (qwen2.5)</label>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç¼–ç¨‹å¯¼å¸ˆã€‚ä½ å¯ä»¥ï¼š
                        <br>â€¢ è¾“å…¥çŸ¥è¯†ç‚¹ï¼Œè®©æˆ‘ä¸ºä½ å‡ºé¢˜
                        <br>â€¢ æäº¤ä»£ç åï¼Œæˆ‘ä¼šç»™ä½ è¯¦ç»†åé¦ˆ
                        <br>â€¢ éšæ—¶å‘æˆ‘æé—®
                    </div>
                </div>

                <div id="code-preview" class="code-preview"></div>

                <div class="chat-input-area">
                    <textarea 
                        id="chatInput" 
                        placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–æƒ³è¯´çš„è¯... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
                        onkeydown="handleChatKeyDown(event)"
                    ></textarea>
                    <button onclick="sendChatMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®åŒº ===
        const DEEPSEEK_KEY = "sk-3190a966238e41199f5c7c4ad61f490b";
        const EXTENSION_ID = "smartcoder.smartcoder";

        let lastTimestamp = 0;
        let currentProblem = null;
        let chatHistory = [];
        let runtimeChart = null;
        let memoryChart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const runtimeChartEl = document.getElementById('runtimeChart');
            const memoryChartEl = document.getElementById('memoryChart');
            
            if (runtimeChartEl) {
                runtimeChart = echarts.init(runtimeChartEl);
            }
            if (memoryChartEl) {
                memoryChart = echarts.init(memoryChartEl);
            }
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿å›¾è¡¨è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                if (runtimeChart) {
                    runtimeChart.resize();
                }
                if (memoryChart) {
                    memoryChart.resize();
                }
            });
        }

        // åˆå§‹åŒ–å›¾è¡¨
        initCharts();

        // === åˆå§‹åŒ– Split.js å¯æ‹–æ‹½åˆ†æ  ===
        function initSplitPanes() {
            // æ°´å¹³åˆ†å‰²ï¼šå·¦ä¾§é¢æ¿å’Œå³ä¾§é¢æ¿
            if (document.getElementById('leftPanel') && document.getElementById('rightPanel')) {
                Split(['#leftPanel', '#rightPanel'], {
                    sizes: [45, 55], // åˆå§‹æ¯”ä¾‹
                    minSize: [200, 300], // æœ€å°å®½åº¦
                    gutterSize: 10,
                    cursor: 'col-resize'
                });
            }

            // å‚ç›´åˆ†å‰²ï¼šå·¦ä¾§é¢æ¿å†…éƒ¨çš„ä¸Šæ–¹åŒºåŸŸï¼ˆçŸ¥è¯†ç‚¹+é¢˜åº“ï¼‰å’Œé¢˜ç›®å¡ç‰‡
            if (document.getElementById('leftTopContainer') && document.getElementById('problemCard')) {
                Split(['#leftTopContainer', '#problemCard'], {
                    direction: 'vertical',
                    sizes: [40, 60], // åˆå§‹æ¯”ä¾‹
                    minSize: [150, 200], // æœ€å°é«˜åº¦
                    gutterSize: 10,
                    cursor: 'row-resize'
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– Split.js
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSplitPanes);
        } else {
            // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿ DOM å®Œå…¨åŠ è½½
            setTimeout(initSplitPanes, 100);
        }

        // === åŠ è½½æœ¬åœ°é¢˜åº“åˆ—è¡¨ ===
        async function loadProblemsList() {
            const problemsListDiv = document.getElementById('problemsList');
            try {
                const response = await fetch('http://localhost:3000/api/problems');
                if (!response.ok) {
                    throw new Error('è·å–é¢˜åº“å¤±è´¥');
                }
                const problems = await response.json();
                
                if (problems.length === 0) {
                    problemsListDiv.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆç”Ÿæˆé¢˜ç›®</div>';
                    return;
                }
                
                // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
                problemsListDiv.innerHTML = problems.map(problem => {
                    const isActive = currentProblem && currentProblem.id === problem.id;
                    return `
                        <div 
                            class="problem-item" 
                            style="
                                padding: 12px; 
                                margin-bottom: 8px; 
                                background: ${isActive ? '#e3f2fd' : '#f5f5f5'}; 
                                border-left: 4px solid ${isActive ? '#0078d4' : '#ccc'};
                                border-radius: 4px;
                                cursor: pointer;
                                transition: all 0.3s;
                            "
                            onclick="loadProblem('${problem.id}')"
                            onmouseover="this.style.background='${isActive ? '#e3f2fd' : '#eeeeee'}'"
                            onmouseout="this.style.background='${isActive ? '#e3f2fd' : '#f5f5f5'}'"
                        >
                            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${problem.title}</div>
                            <div style="font-size: 12px; color: #666;">
                                <span>ID: ${problem.id}</span> | 
                                <span>éš¾åº¦: ${problem.difficulty || 'ä¸­ç­‰'}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('åŠ è½½é¢˜åº“åˆ—è¡¨å¤±è´¥:', error);
                problemsListDiv.innerHTML = '<div style="padding: 10px; color: #f44336; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</div>';
            }
        }

        // === åŠ è½½æŒ‡å®šé¢˜ç›® ===
        async function loadProblem(problemId) {
            try {
                const response = await fetch(`http://localhost:3000/api/problem/${problemId}`);
                if (!response.ok) {
                    throw new Error('è·å–é¢˜ç›®å¤±è´¥');
                }
                const problemData = await response.json();
                
                // æ›´æ–°å½“å‰é¢˜ç›®
                currentProblem = problemData;
                
                // æ›´æ–°é¢˜ç›®å¡ç‰‡
                document.getElementById('problemTitle').textContent = `é¢˜ç›® ${problemData.id}: ${problemData.title}`;
                document.getElementById('problemId').textContent = `éš¾åº¦ï¼š${problemData.difficulty || 'ä¸­ç­‰'} | ID: ${problemData.id}`;
                document.getElementById('problemDescription').textContent = problemData.description || 'æš‚æ— æè¿°';
                document.getElementById('openVsCodeBtn').disabled = false;
                
                // åˆ·æ–°é¢˜åº“åˆ—è¡¨ï¼ˆé«˜äº®å½“å‰é¢˜ç›®ï¼‰
                await loadProblemsList();
                
                addChatMessage('system', `å·²åˆ‡æ¢åˆ°é¢˜ç›®ï¼š${problemData.title}`);
                
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                addChatMessage('system', `åŠ è½½é¢˜ç›®å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½é¢˜åº“åˆ—è¡¨
        loadProblemsList();

        // === çŸ¥è¯†ç‚¹è¾“å…¥å’ŒAIå‡ºé¢˜ ===
        async function generateProblem() {
            const knowledge = document.getElementById('knowledgeInput').value.trim();
            if (!knowledge) {
                addChatMessage('system', 'è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ æ­£åœ¨å‡ºé¢˜...';

            addChatMessage('user', `æˆ‘æƒ³å­¦ä¹ ï¼š${knowledge}`);

            const prompt = `è¯·ä¸ºå­¦ç”Ÿå­¦ä¹ ä»¥ä¸‹çŸ¥è¯†ç‚¹ç”Ÿæˆä¸€é“ç¼–ç¨‹é¢˜ç›®ã€‚

çŸ¥è¯†ç‚¹ï¼š${knowledge}

è¦æ±‚ï¼š
1. ç”Ÿæˆä¸€é“é€‚åˆåˆå­¦è€…çš„ç¼–ç¨‹é¢˜ç›®
2. é¢˜ç›®åº”è¯¥æ¶µç›–è¯¥çŸ¥è¯†ç‚¹
3. æä¾›æ¸…æ™°çš„é¢˜ç›®æè¿°ï¼ˆåŒ…æ‹¬è¾“å…¥è¾“å‡ºæ ¼å¼ï¼‰
4. é¢˜ç›®éš¾åº¦é€‚ä¸­
5. **å¿…é¡»ç”Ÿæˆè‡³å°‘3ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åŒ…å«è¾“å…¥å’ŒæœŸæœ›è¾“å‡º

âš ï¸ é‡è¦ï¼šå¿…é¡»ä¸”åªèƒ½è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ã€‚
æ ¼å¼ï¼š
{
  "title": "é¢˜ç›®åç§°",
  "id": ${Date.now()},
  "description": "é¢˜ç›®è¯¦ç»†æè¿°ï¼ˆæ”¯æŒæ¢è¡Œ\\nï¼Œå¿…é¡»æ˜ç¡®è¯´æ˜è¾“å…¥è¾“å‡ºæ ¼å¼ï¼‰",
  "difficulty": "ç®€å•",
  "testCases": [
    {"input": "è¾“å…¥æ ·ä¾‹1", "expected": "æœŸæœ›è¾“å‡º1"},
    {"input": "è¾“å…¥æ ·ä¾‹2", "expected": "æœŸæœ›è¾“å‡º2"},
    {"input": "è¾“å…¥æ ·ä¾‹3", "expected": "æœŸæœ›è¾“å‡º3"}
  ]
}

æ³¨æ„ï¼š
- id å¿…é¡»æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼Œå»ºè®®ä½¿ç”¨æ—¶é—´æˆ³
- testCases æ˜¯æ•°ç»„ï¼Œå¿…é¡»åŒ…å«è‡³å°‘3ä¸ªæµ‹è¯•ç”¨ä¾‹
- input å’Œ expected éƒ½æ˜¯å­—ç¬¦ä¸²
- expected å¿…é¡»æ˜¯è¯¥é¢˜ç›®çš„æ ‡å‡†æ­£ç¡®è¾“å‡º`;

            try {
                // ä½¿ç”¨ JSON æ¨¡å¼è°ƒç”¨ AI
                const response = await callAIAPI(prompt, true);
                
                // æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—
                let jsonStr = response.trim();
                
                // ç§»é™¤ ```json å’Œ ``` æ ‡è®°
                jsonStr = jsonStr.replace(/^```json\s*/i, '');
                jsonStr = jsonStr.replace(/^```\s*/, '');
                jsonStr = jsonStr.replace(/\s*```$/g, '');
                jsonStr = jsonStr.trim();
                
                // å°è¯•æå– JSON å¯¹è±¡ï¼ˆå¦‚æœ AI åœ¨ JSON å‰åæ·»åŠ äº†æ–‡å­—ï¼‰
                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }
                
                const problemData = JSON.parse(jsonStr);
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (!problemData.title || !problemData.id) {
                    throw new Error('é¢˜ç›®æ•°æ®ä¸å®Œæ•´ï¼šç¼ºå°‘ title æˆ– id');
                }
                
                // éªŒè¯æµ‹è¯•ç”¨ä¾‹
                if (!problemData.testCases || !Array.isArray(problemData.testCases) || problemData.testCases.length === 0) {
                    throw new Error('é¢˜ç›®æ•°æ®ä¸å®Œæ•´ï¼šå¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹');
                }
                
                // ç¡®ä¿ id æ˜¯å­—ç¬¦ä¸²
                problemData.id = String(problemData.id);
                
                // ä¿å­˜é¢˜ç›®åˆ°åç«¯
                try {
                    const saveResponse = await fetch('http://localhost:3000/api/problems', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: problemData.id,
                            title: problemData.title,
                            description: problemData.description,
                            difficulty: problemData.difficulty || 'ä¸­ç­‰',
                            testCases: problemData.testCases
                        })
                    });
                    
                    if (!saveResponse.ok) {
                        const errorData = await saveResponse.json().catch(() => ({ error: 'ä¿å­˜å¤±è´¥' }));
                        throw new Error(errorData.error || 'ä¿å­˜é¢˜ç›®å¤±è´¥');
                    }
                    
                    const saveResult = await saveResponse.json();
                    console.log('é¢˜ç›®å·²ä¿å­˜åˆ°åç«¯:', saveResult);
                    
                    // åˆ·æ–°æœ¬åœ°é¢˜åº“åˆ—è¡¨
                    await loadProblemsList();
                    
                } catch (saveError) {
                    console.error('ä¿å­˜é¢˜ç›®å¤±è´¥:', saveError);
                    addChatMessage('system', `âš ï¸ é¢˜ç›®ç”ŸæˆæˆåŠŸï¼Œä½†ä¿å­˜åˆ°æœ¬åœ°é¢˜åº“å¤±è´¥: ${saveError.message}`);
                }
                
                // æ›´æ–°é¢˜ç›®å¡ç‰‡
                currentProblem = problemData;
                document.getElementById('problemTitle').textContent = `é¢˜ç›® ${problemData.id}: ${problemData.title}`;
                document.getElementById('problemId').textContent = `éš¾åº¦ï¼š${problemData.difficulty || 'ä¸­ç­‰'} | ID: ${problemData.id}`;
                document.getElementById('problemDescription').textContent = problemData.description || 'æš‚æ— æè¿°';
                document.getElementById('openVsCodeBtn').disabled = false;

                addChatMessage('ai', `âœ… é¢˜ç›®å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°é¢˜åº“ï¼\n\n**${problemData.title}**\n\n${problemData.description}\n\nğŸ“ åŒ…å« ${problemData.testCases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹\n\nç‚¹å‡»"åœ¨ VS Code ä¸­ç¼–ç¨‹"å¼€å§‹è§£é¢˜å§ï¼`);

            } catch (e) {
                console.error("å‡ºé¢˜å¤±è´¥:", e);
                addChatMessage('ai', `âŒ å‡ºé¢˜å¤±è´¥: ${e.message}\n\nè¯·é‡è¯•æˆ–æ¢ä¸ªçŸ¥è¯†ç‚¹ã€‚å¦‚æœå¤šæ¬¡å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ›´å…·ä½“çš„çŸ¥è¯†ç‚¹æè¿°ï¼ˆä¾‹å¦‚ï¼š"æ•°ç»„æ’åº"è€Œä¸æ˜¯"æ•°ç»„"ï¼‰ã€‚`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ² AI å‡ºé¢˜';
            }
        }

        // === VS Code æ‰“å¼€é¢˜ç›® ===
        function openVsCode() {
            if (!currentProblem) {
                addChatMessage('system', 'è¯·å…ˆç”Ÿæˆé¢˜ç›®ï¼');
                return;
            }

            const title = encodeURIComponent(currentProblem.title);
            const desc = encodeURIComponent(currentProblem.description);
            window.location.href = `vscode://${EXTENSION_ID}/solve?id=${currentProblem.id}&title=${title}&desc=${desc}`;
            
            addChatMessage('system', 'æ­£åœ¨æ‰“å¼€ VS Code...');
        }

        // === èŠå¤©åŠŸèƒ½ ===
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingId = addChatMessage('ai', 'ğŸ¤” æ€è€ƒä¸­...', true);

            try {
                const response = await callAIAPI(message);
                updateChatMessage(loadingId, response);
            } catch (e) {
                console.error("AI å›å¤å¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š${e.message}`);
            }
        }

        function addChatMessage(role, content, isTemp = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random();
            messageDiv.id = messageId;
            messageDiv.className = `message ${role}`;
            
            // âœ¨ Render Markdown for AI messages, plain text for user/system
            if (role === 'ai' && typeof marked !== 'undefined') {
                // Configure marked for safe parsing
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: false,
                    mangle: false
                });
                messageDiv.innerHTML = marked.parse(content);
                
                // Highlight code blocks after rendering
                if (typeof hljs !== 'undefined') {
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
            } else {
                // User and system messages: plain text with line breaks
                messageDiv.textContent = content;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (isTemp) {
                messageDiv.classList.add('loading');
            }

            return messageId;
        }

        function updateChatMessage(messageId, newContent) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.classList.remove('loading');
                
                // âœ¨ Render Markdown for AI messages
                if (messageDiv.classList.contains('ai') && typeof marked !== 'undefined') {
                    // Configure marked for safe parsing
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: false,
                        mangle: false
                    });
                    messageDiv.innerHTML = marked.parse(newContent);
                    
                    // Highlight code blocks after rendering
                    if (typeof hljs !== 'undefined') {
                        messageDiv.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                } else {
                    // Fallback: plain text with line breaks
                    messageDiv.textContent = newContent;
                    messageDiv.innerHTML = newContent.replace(/\n/g, '<br>');
                }
            }
        }

        // === ä»£ç æäº¤å¤„ç†ï¼ˆåŒ…å«æ€§èƒ½æ•°æ®ï¼‰ ===
        async function handleNewSubmission(data) {
            console.log('[ç½‘é¡µç«¯] handleNewSubmission è¢«è°ƒç”¨ï¼Œæ•°æ®:', data);
            
            document.getElementById('sync-dot').classList.add('active');
            document.getElementById('last-update').textContent = 'æ”¶åˆ°æ–°ä»£ç : ' + new Date().toLocaleTimeString();
            
            // éšè—ä»£ç é¢„è§ˆåŒºåŸŸ
            // const preview = document.getElementById('code-preview');
            // preview.style.display = 'block';
            // preview.textContent = data.code;

            // âœ¨ ä½¿ç”¨æ’ä»¶ç«¯ä¼ æ¥çš„ status å­—æ®µåˆ¤æ–­çŠ¶æ€ï¼ˆæ’ä»¶ç«¯å·²ç»æ ¹æ®æµ‹è¯•ç”¨ä¾‹éªŒè¯è¿‡äº†ï¼‰
            const status = data.status || 'Unknown';
            const isAccepted = status === 'Accepted';
            
            // æ˜¾ç¤º LeetCode é£æ ¼çš„ç»“æœå±•ç¤º
            const resultContainer = document.getElementById('resultContainer');
            const resultBanner = document.getElementById('resultBanner');
            
            // åªè¦æœ‰æ€§èƒ½æ•°æ®æˆ–çŠ¶æ€ä¿¡æ¯ï¼Œå°±æ˜¾ç¤ºç»“æœ
            if (data.runtime >= 0 && data.memory >= 0 || status !== 'Unknown') {
                resultContainer.style.display = 'block';
                
                // æ ¹æ® status æ›´æ–°çŠ¶æ€æ¨ªå¹…
                if (status === 'Accepted') {
                    resultBanner.className = 'result-banner accepted';
                    resultBanner.innerHTML = '<span>âœ“</span><span>Accepted</span>';
                } else if (status === 'Wrong Answer') {
                    resultBanner.className = 'result-banner error';
                    resultBanner.innerHTML = '<span>âœ—</span><span>Wrong Answer</span>';
                } else if (status === 'Runtime Error' || status === 'Compile Error') {
                    resultBanner.className = 'result-banner error';
                    resultBanner.innerHTML = `<span>âœ—</span><span>${status}</span>`;
                } else {
                    // å…¼å®¹æ—§é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰ statusï¼Œæ ¹æ® runtime å’Œ memory åˆ¤æ–­
                    const hasValidPerf = data.runtime >= 0 && data.memory >= 0;
                    const hasError = data.output && (data.output.toLowerCase().includes('error') || data.output.toLowerCase().includes('exception'));
                    if (hasValidPerf && !hasError) {
                        resultBanner.className = 'result-banner accepted';
                        resultBanner.innerHTML = '<span>âœ“</span><span>Accepted</span>';
                    } else {
                        resultBanner.className = 'result-banner error';
                        resultBanner.innerHTML = '<span>âœ—</span><span>Error</span>';
                    }
                }
                
                // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡ï¼ˆåªè¦æœ‰æ€§èƒ½æ•°æ®å°±æ˜¾ç¤ºï¼‰
                if (data.runtime >= 0 && data.memory >= 0) {
                    const runtimeValue = data.runtime;
                    const memoryValueMB = (data.memory / (1024 * 1024)).toFixed(2);
                    
                    document.getElementById('runtimeValue').textContent = runtimeValue;
                    document.getElementById('memoryValue').textContent = memoryValueMB;
                    
                    // æ›´æ–°å‡»è´¥ç‡
                    const runtimeBeatPctEl = document.getElementById('runtimeBeatPct');
                    const memoryBeatPctEl = document.getElementById('memoryBeatPct');
                    
                    if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                        runtimeBeatPctEl.textContent = `å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·`;
                    } else {
                        runtimeBeatPctEl.textContent = '';
                    }
                    
                    if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                        memoryBeatPctEl.textContent = `å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·`;
                    } else {
                        memoryBeatPctEl.textContent = '';
                    }
                    
                    // æ¸²æŸ“åˆ†å¸ƒå›¾è¡¨ï¼ˆéœ€è¦ä»åç«¯è·å–å†å²æ•°æ®æˆ–æ¨¡æ‹Ÿæ•°æ®ï¼‰
                    await renderDistributionCharts(data);
                } else {
                    // å¦‚æœæ²¡æœ‰æ€§èƒ½æ•°æ®ï¼Œéšè—æ€§èƒ½æŒ‡æ ‡éƒ¨åˆ†
                    document.getElementById('runtimeValue').textContent = '-';
                    document.getElementById('memoryValue').textContent = '-';
                    document.getElementById('runtimeBeatPct').textContent = '';
                    document.getElementById('memoryBeatPct').textContent = '';
                }
            } else {
                resultContainer.style.display = 'none';
            }

            // åœ¨èŠå¤©ä¸­ä¹Ÿæ˜¾ç¤ºç®€è¦ä¿¡æ¯
            let perfInfo = '';
            
            // âœ¨ æ ¹æ® status æ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯
            if (status === 'Accepted') {
                perfInfo = `\n\nâœ… **çŠ¶æ€: Accepted**`;
                if (data.runtime >= 0 && data.memory >= 0) {
                    perfInfo += `\n\nâš¡ **æ€§èƒ½è¯„æµ‹ç»“æœ**\n- è¿è¡Œæ—¶é—´: ${data.runtime}ms`;
                    if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·**`;
                    }
                    perfInfo += `\n- å†…å­˜ä½¿ç”¨: ${(data.memory / 1024).toFixed(2)}KB`;
                    if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·**`;
                    }
                }
                if (data.output) {
                    perfInfo += `\n\nğŸ“¤ **ç¨‹åºè¾“å‡º:**\n\`\`\`\n${data.output}\n\`\`\``;
                }
            } else if (status === 'Wrong Answer') {
                perfInfo = `\n\nâŒ **çŠ¶æ€: Wrong Answer**`;
                if (data.failedCase) {
                    perfInfo += `\n- æµ‹è¯•ç”¨ä¾‹ ${data.failedCase} å¤±è´¥`;
                }
                if (data.errorMessage) {
                    perfInfo += `\n- ${data.errorMessage}`;
                }
                if (data.runtime >= 0 && data.memory >= 0) {
                    perfInfo += `\n\nâš¡ **æ€§èƒ½è¯„æµ‹ç»“æœ**\n- è¿è¡Œæ—¶é—´: ${data.runtime}ms`;
                    if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·**`;
                    }
                    perfInfo += `\n- å†…å­˜ä½¿ç”¨: ${(data.memory / 1024).toFixed(2)}KB`;
                    if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·**`;
                    }
                }
                if (data.output) {
                    perfInfo += `\n\nğŸ“¤ **å®é™…è¾“å‡º:**\n\`\`\`\n${data.output}\n\`\`\``;
                }
            } else if (status === 'Runtime Error' || status === 'Compile Error') {
                perfInfo = `\n\nâŒ **çŠ¶æ€: ${status}**`;
                if (data.errorMessage || data.output) {
                    perfInfo += `\n\n**é”™è¯¯ä¿¡æ¯:**\n\`\`\`\n${data.errorMessage || data.output}\n\`\`\``;
                }
            } else {
                // å…¼å®¹æ—§é€»è¾‘ï¼ˆæ²¡æœ‰ status å­—æ®µï¼‰
                if (data.runtime >= 0 && data.memory >= 0) {
                    perfInfo = `\n\nâš¡ **æ€§èƒ½è¯„æµ‹ç»“æœ**\n- è¿è¡Œæ—¶é—´: ${data.runtime}ms`;
                    if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·**`;
                    }
                    perfInfo += `\n- å†…å­˜ä½¿ç”¨: ${(data.memory / 1024).toFixed(2)}KB`;
                    if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                        perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·**`;
                    }
                    if (data.output) {
                        perfInfo += `\n\nğŸ“¤ **ç¨‹åºè¾“å‡º:**\n\`\`\`\n${data.output}\n\`\`\``;
                    }
                }
            }


            await fetch('http://localhost:3000/api/mark_read', { method: 'POST' });

            // âœ¨ å…ˆåˆ†æå¤æ‚åº¦
            try {
                await analyzeComplexity(data.code);
            } catch (e) {
                console.error("å¤æ‚åº¦åˆ†æå¤±è´¥:", e);
            }

            const loadingId = addChatMessage('ai', 'ğŸ¤” æ­£åœ¨åˆ†æä½ çš„ä»£ç å’Œæ€§èƒ½æ•°æ®...', true);

            try {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªè‹æ ¼æ‹‰åº•å¼çš„ç¼–ç¨‹å¯¼å¸ˆã€‚å­¦ç”Ÿæäº¤äº†ä»£ç ï¼Œå¹¶æä¾›äº†æ€§èƒ½è¯„æµ‹æ•°æ®å’Œæ’åã€‚
è¯·ä¸è¦ç›´æ¥ç»™å‡ºæ­£ç¡®ç­”æ¡ˆã€‚
ä½ éœ€è¦ï¼š
1. åˆ†æä»£ç é€»è¾‘ã€‚
2. åˆ†ææ€§èƒ½æ•°æ®ï¼ˆè¿è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨ï¼‰ï¼Œç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚
3. å¦‚æœä»£ç æœ‰é”™ï¼Œç”¨å¼•å¯¼æ€§çš„é—®é¢˜å¯å‘å­¦ç”Ÿï¼ˆä¾‹å¦‚ï¼š"ä½ è€ƒè™‘è¿‡æ•°ç»„ä¸ºç©ºçš„æƒ…å†µå—ï¼Ÿ"ï¼‰ã€‚
4. å¦‚æœä»£ç æ˜¯å¯¹çš„ï¼Œæå‡ºä¼˜åŒ–é—®é¢˜ï¼ˆä¾‹å¦‚ï¼š"ç°åœ¨çš„å¤æ‚åº¦æ˜¯O(n^2)ï¼Œèƒ½ä¼˜åŒ–åˆ°O(n)å—ï¼Ÿ"ï¼‰ã€‚
5. å¦‚æœæä¾›äº†å‡»è´¥ç‡æ•°æ®ï¼Œå¯ä»¥é¼“åŠ±å­¦ç”Ÿæˆ–æå‡ºæ”¹è¿›å»ºè®®ã€‚

å­¦ç”Ÿä»£ç ï¼š
${data.code}

${data.output ? `ç¨‹åºè¾“å‡ºï¼š\n${data.output}\n` : ''}
${data.runtime >= 0 ? `è¿è¡Œæ—¶é—´ï¼š${data.runtime}ms${data.beatRuntimePct !== null && data.beatRuntimePct !== undefined ? ` (å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·)` : ''}\n` : ''}
${data.memory >= 0 ? `å†…å­˜ä½¿ç”¨ï¼š${(data.memory / 1024).toFixed(2)}KB${data.beatMemoryPct !== null && data.beatMemoryPct !== undefined ? ` (å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·)` : ''}\n` : ''}
å½“å‰é¢˜ç›®ï¼š${currentProblem ? currentProblem.title : 'æœªçŸ¥'}`;

                const feedback = await callAIAPI(prompt);
                updateChatMessage(loadingId, feedback);
                
                // âœ¨ æ£€æŸ¥å¤æ‚åº¦ï¼Œå¦‚æœè¿‡é«˜åˆ™æç¤ºä¼˜åŒ–å»ºè®®
                const timeComplexity = document.getElementById('timeComplexity').textContent;
                if (timeComplexity && timeComplexity !== '-') {
                    // æ£€æµ‹é«˜å¤æ‚åº¦æ¨¡å¼
                    const highComplexityPatterns = [
                        /O\(n\^2\)/i,
                        /O\(nÂ²\)/i,
                        /O\(2\^n\)/i,
                        /O\(n!\)/i,
                        /O\(n\*m\)/i,
                        /O\(n\*log\(n\)\*m\)/i
                    ];
                    
                    const isHighComplexity = highComplexityPatterns.some(pattern => pattern.test(timeComplexity));
                    
                    if (isHighComplexity) {
                        // å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿èŠå¤©æ¶ˆæ¯å·²ç»æ˜¾ç¤º
                        setTimeout(() => {
                            addChatMessage('ai', 'ğŸ’¡ æ£€æµ‹åˆ°æ—¶é—´å¤æ‚åº¦è¿‡é«˜ï¼ˆ' + timeComplexity + 'ï¼‰ï¼Œæ˜¯å¦è€ƒè™‘ä½¿ç”¨å“ˆå¸Œè¡¨ã€åŒæŒ‡é’ˆæˆ–åŠ¨æ€è§„åˆ’ç­‰ä¼˜åŒ–æ–¹æ³•ï¼Ÿ');
                        }, 500);
                    }
                }
            } catch (e) {
                console.error("åˆ†æå¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ åˆ†æå¤±è´¥: ${e.message}`);
            } finally {
                document.getElementById('sync-dot').classList.remove('active');
            }
        }

        // === âœ¨ æ¸²æŸ“å†å²è¶‹åŠ¿å›¾è¡¨ï¼ˆæŠ˜çº¿å›¾ï¼‰ ===
        async function renderDistributionCharts(currentData) {
            try {
                // ä»åç«¯è·å–å†å²æ•°æ®ï¼ˆæŒ‰å½“å‰é—®é¢˜IDç­›é€‰ï¼‰
                const problemId = currentProblem ? currentProblem.id : null;
                const statsUrl = problemId 
                    ? `http://localhost:3000/api/stats?problemId=${problemId}`
                    : 'http://localhost:3000/api/stats';
                
                const stats = await fetch(statsUrl).then(r => r.json()).catch(() => null);
                
                // âœ¨ ä½¿ç”¨å†å²æ•°æ®æ¸²æŸ“æŠ˜çº¿å›¾
                if (stats && stats.history && stats.history.length > 0) {
                    // æœ‰å†å²æ•°æ®ï¼Œæ¸²æŸ“æŠ˜çº¿å›¾
                    renderTrendChart(runtimeChart, stats.history, 'runtime', 'ms', currentData.runtime);
                    renderTrendChart(memoryChart, stats.history, 'memory', 'MB', currentData.memory / (1024 * 1024));
                } else {
                    // æ²¡æœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºæˆ–ç©ºå›¾è¡¨
                    renderEmptyChart(runtimeChart, 'è¿è¡Œæ—¶é—´è¶‹åŠ¿', 'ms');
                    renderEmptyChart(memoryChart, 'å†…å­˜ä½¿ç”¨è¶‹åŠ¿', 'MB');
                }
                
            } catch (e) {
                console.error('æ¸²æŸ“å›¾è¡¨å¤±è´¥:', e);
            }
        }

        // æ ¹æ®æ•°æ®è®¡ç®—åˆç†çš„åŒºé—´
        function calculateRanges(values, currentValue, step) {
            if (values.length === 0) {
                return generateRanges(0, Math.max(currentValue * 2, 100), step);
            }
            
            const allValues = [...values, currentValue];
            const min = Math.floor(Math.min(...allValues) / step) * step;
            const max = Math.ceil(Math.max(...allValues) / step) * step;
            
            return generateRanges(min, max, step);
        }

        // æ ¹æ®çœŸå®æ•°æ®è®¡ç®—åˆ†å¸ƒ
        function calculateDistribution(values, ranges) {
            const distribution = new Array(ranges.length).fill(0);
            
            values.forEach(value => {
                for (let i = 0; i < ranges.length; i++) {
                    const range = ranges[i];
                    const rangeStart = parseInt(range.split('-')[0]);
                    const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                    
                    if (value >= rangeStart && value < rangeEnd) {
                        distribution[i]++;
                        break;
                    }
                }
            });
            
            return distribution;
        }

        // ç”ŸæˆåŒºé—´æ•°ç»„
        function generateRanges(min, max, step) {
            const ranges = [];
            for (let i = min; i < max; i += step) {
                ranges.push(`${i}-${i + step}`);
            }
            ranges.push(`${max}+`);
            return ranges;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†å¸ƒæ•°æ®ï¼ˆå½“æ²¡æœ‰å†å²æ•°æ®æ—¶ä½¿ç”¨ï¼‰
        function generateMockDistribution(ranges, currentValue) {
            const distribution = [];
            for (let i = 0; i < ranges.length; i++) {
                const range = ranges[i];
                const rangeStart = parseInt(range.split('-')[0]);
                const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                
                if (currentValue >= rangeStart && currentValue < rangeEnd) {
                    // å½“å‰å€¼æ‰€åœ¨åŒºé—´ï¼Œè®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„å€¼ï¼ˆæ¨¡æ‹Ÿæœ‰å…¶ä»–ç”¨æˆ·ï¼‰
                    distribution.push(Math.floor(Math.random() * 15) + 3);
                } else {
                    // å…¶ä»–åŒºé—´ï¼Œéšæœºè¾ƒå°çš„å€¼
                    distribution.push(Math.floor(Math.random() * 8));
                }
            }
            return distribution;
        }

        // âœ¨ æ¸²æŸ“å†å²è¶‹åŠ¿æŠ˜çº¿å›¾
        function renderTrendChart(chart, history, dataKey, unit, currentValue) {
            if (!chart) return;
            
            // å‡†å¤‡æ•°æ®ï¼šæ—¶é—´æˆ³ -> æ ¼å¼åŒ–æ—¶é—´ï¼Œæ•°æ®å€¼
            const times = history.map(h => {
                const date = new Date(h.timestamp);
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            });
            
            const values = history.map(h => h[dataKey]);
            
            // æ·»åŠ å½“å‰å€¼ï¼ˆå¦‚æœä¸åœ¨å†å²ä¸­ï¼‰
            const lastTimestamp = history.length > 0 ? history[history.length - 1].timestamp : Date.now();
            if (currentValue !== undefined && (history.length === 0 || lastTimestamp < Date.now() - 1000)) {
                times.push(new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
                values.push(currentValue);
            }
            
            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#ffffff'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line'
                    },
                    backgroundColor: '#1e1e1e',
                    borderColor: '#3c3c3c',
                    borderWidth: 1,
                    padding: [8, 12],
                    textStyle: {
                        color: '#ffffff',
                        fontSize: 12
                    },
                    formatter: function(params) {
                        const param = params[0];
                        return `${param.name}<br/>${dataKey === 'runtime' ? 'è¿è¡Œæ—¶é—´' : 'å†…å­˜ä½¿ç”¨'}: ${param.value} ${unit}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    axisLabel: {
                        color: '#9ca3af',
                        rotate: 45,
                        fontSize: 11,
                        margin: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: dataKey === 'runtime' ? 'è¿è¡Œæ—¶é—´ (ms)' : 'å†…å­˜ä½¿ç”¨ (MB)',
                    nameTextStyle: {
                        color: '#9ca3af',
                        fontSize: 11,
                        padding: [0, 0, 0, -15]
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    axisLabel: {
                        color: '#9ca3af',
                        fontSize: 11
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#3c3c3c',
                            type: 'dashed',
                            width: 1
                        }
                    }
                },
                series: [{
                    name: dataKey === 'runtime' ? 'è¿è¡Œæ—¶é—´' : 'å†…å­˜ä½¿ç”¨',
                    type: 'line',
                    smooth: true,
                    data: values,
                    lineStyle: {
                        color: '#2cbb5d', // LeetCode ç»¿è‰²
                        width: 2
                    },
                    itemStyle: {
                        color: '#2cbb5d',
                        borderColor: '#1e1e1e',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [
                                { offset: 0, color: 'rgba(44, 187, 93, 0.3)' },
                                { offset: 1, color: 'rgba(44, 187, 93, 0.05)' }
                            ]
                        }
                    },
                    emphasis: {
                        focus: 'series'
                    }
                }]
            };
            
            chart.setOption(option, true);
            
            // ç¡®ä¿å›¾è¡¨è‡ªé€‚åº”å®¹å™¨å¤§å°
            setTimeout(() => {
                chart.resize();
            }, 100);
        }

        // æ¸²æŸ“ç©ºå›¾è¡¨ï¼ˆæ— æ•°æ®æ—¶ï¼‰
        function renderEmptyChart(chart, title, unit) {
            if (!chart) return;
            
            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#ffffff'
                },
                title: {
                    text: 'æš‚æ— å†å²æ•°æ®',
                    left: 'center',
                    top: 'middle',
                    textStyle: {
                        color: '#858585',
                        fontSize: 14
                    }
                },
                xAxis: {
                    type: 'category',
                    data: [],
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#9ca3af' }
                },
                yAxis: {
                    type: 'value',
                    name: unit,
                    nameTextStyle: { color: '#9ca3af' },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#9ca3af' },
                    splitLine: {
                        show: true,
                        lineStyle: { color: '#3c3c3c', type: 'dashed', width: 1 }
                    }
                },
                series: []
            };
            
            chart.setOption(option, true);
        }

        // ä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹ï¼ˆå·²åºŸå¼ƒï¼Œä½†ä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        function renderChart(chart, ranges, distribution, currentValue, unit) {
            if (!chart) return;
            
            // æ‰¾åˆ°å½“å‰å€¼æ‰€åœ¨çš„åŒºé—´ç´¢å¼•
            let currentIndex = -1;
            for (let i = 0; i < ranges.length; i++) {
                const range = ranges[i];
                const rangeStart = parseInt(range.split('-')[0]);
                const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                
                if (currentValue >= rangeStart && currentValue < rangeEnd) {
                    currentIndex = i;
                    break;
                }
            }
            
            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#ffffff'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: '#1e1e1e',
                    borderColor: '#3c3c3c',
                    borderWidth: 1,
                    padding: [8, 12],
                    textStyle: {
                        color: '#ffffff',
                        fontSize: 12
                    },
                    formatter: function(params) {
                        const param = params[0];
                        return `${param.name}<br/>ç”¨æˆ·æ•°é‡: ${param.value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ranges,
                    axisLine: {
                        show: false  // ä¸æ˜¾ç¤ºåæ ‡è½´çº¿
                    },
                    axisTick: {
                        show: false  // ä¸æ˜¾ç¤ºåˆ»åº¦çº¿
                    },
                    axisLabel: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        rotate: 45,
                        fontSize: 11,
                        margin: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'ç”¨æˆ·æ•°é‡',
                    nameTextStyle: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        fontSize: 11,
                        padding: [0, 0, 0, -15]
                    },
                    axisLine: {
                        show: false  // ä¸æ˜¾ç¤ºåæ ‡è½´çº¿
                    },
                    axisTick: {
                        show: false  // ä¸æ˜¾ç¤ºåˆ»åº¦çº¿
                    },
                    axisLabel: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        fontSize: 11
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#3c3c3c',  // æ·±ç°è‰²åˆ†å‰²çº¿
                            type: 'dashed',  // è™šçº¿
                            width: 1
                        }
                    }
                },
                series: [{
                    name: 'ç”¨æˆ·æ•°é‡',
                    type: 'bar',
                    barWidth: '60%',
                    data: distribution.map((value, index) => {
                        if (index === currentIndex) {
                            // é«˜äº®å½“å‰å€¼æ‰€åœ¨åŒºé—´ - ä½¿ç”¨ LeetCode æ ‡å¿—æ€§ç»¿è‰²
                            return {
                                value: value,
                                itemStyle: {
                                    color: '#2cbb5d'  // LeetCode æ ‡å¿—æ€§ç»¿è‰²
                                }
                            };
                        }
                        // å…¶ä»–æŸ±å­ä½¿ç”¨æ·±ç°è‰²
                        return {
                            value: value,
                            itemStyle: {
                                color: '#4b5563'  // æ·±ç°è‰²
                            }
                        };
                    }),
                    label: {
                        show: false
                    },
                    emphasis: {
                        itemStyle: {
                            color: '#2cbb5d'  // é¼ æ ‡æ‚¬åœæ—¶ä¹Ÿæ˜¾ç¤ºç»¿è‰²
                        }
                    }
                }]
            };
            
            chart.setOption(option, true);
            
            // ç¡®ä¿å›¾è¡¨è‡ªé€‚åº”å®¹å™¨å¤§å°
            setTimeout(() => {
                chart.resize();
            }, 100);
        }

        // === âœ¨ å¤æ‚åº¦åˆ†æå‡½æ•° ===
        async function analyzeComplexity(code) {
            const prompt = `è¯·åƒæŠ€æœ¯é¢è¯•å®˜ä¸€æ ·ï¼Œä»”ç»†åˆ†æä»¥ä¸‹ C# ä»£ç çš„æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦ã€‚

ä»£ç ï¼š
\`\`\`csharp
${code}
\`\`\`

è¯·åˆ†æï¼š
1. æ—¶é—´å¤æ‚åº¦ï¼šåˆ†æå¾ªç¯åµŒå¥—ã€é€’å½’è°ƒç”¨ç­‰å…³é”®æ“ä½œ
2. ç©ºé—´å¤æ‚åº¦ï¼šåˆ†æé¢å¤–ä½¿ç”¨çš„æ•°ç»„ã€æ ˆã€é€’å½’è°ƒç”¨æ ˆç­‰
3. è¯¦ç»†è§£é‡Šï¼šè¯´æ˜ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå¤æ‚åº¦ï¼ŒæŒ‡å‡ºå…³é”®ä»£ç æ®µ

âš ï¸ å¿…é¡»ä¸”åªèƒ½è¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚
æ ¼å¼ï¼š
{
  "timeComplexity": "O(n)",
  "spaceComplexity": "O(1)",
  "explanation": "è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå¤æ‚åº¦ï¼ŒåŒ…æ‹¬å…³é”®ä»£ç æ®µçš„åˆ†æ"
}`;

            try {
                const response = await callAIAPI(prompt, true, false); // å¤æ‚åº¦åˆ†æä¸æ›´æ–°èŠå¤©å†å²
                
                // æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—
                let jsonStr = response.trim();
                jsonStr = jsonStr.replace(/^```json\s*/i, '');
                jsonStr = jsonStr.replace(/^```\s*/, '');
                jsonStr = jsonStr.replace(/\s*```$/g, '');
                jsonStr = jsonStr.trim();
                
                // å°è¯•æå– JSON å¯¹è±¡
                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }
                
                const complexityData = JSON.parse(jsonStr);
                
                // æ˜¾ç¤ºå¤æ‚åº¦åˆ†æ
                document.getElementById('timeComplexity').textContent = complexityData.timeComplexity || '-';
                document.getElementById('spaceComplexity').textContent = complexityData.spaceComplexity || '-';
                document.getElementById('complexityExplanation').textContent = complexityData.explanation || '';
                document.getElementById('complexityCard').style.display = 'block';
                
            } catch (e) {
                console.error("å¤æ‚åº¦åˆ†æè§£æå¤±è´¥:", e);
                // å¦‚æœè§£æå¤±è´¥ï¼Œéšè—å¡ç‰‡
                document.getElementById('complexityCard').style.display = 'none';
            }
        }

        // === AI API è°ƒç”¨ ===
        async function callAIAPI(prompt, useJsonMode = false, updateHistory = true) {
            // âœ¨ è·å–æ˜¯å¦ä½¿ç”¨æœ¬åœ°æ¨¡å‹
            const useLocalModelCheckbox = document.getElementById('useLocalModel');
            const useLocalModel = useLocalModelCheckbox ? useLocalModelCheckbox.checked : false;

            let apiUrl = "https://api.deepseek.com/chat/completions";
            let modelName = "deepseek-chat";
            let apiKey = String(DEEPSEEK_KEY).trim();

            // âœ¨ å¦‚æœæ˜¯æœ¬åœ°æ¨¡å¼ï¼Œä¿®æ”¹é…ç½®
            if (useLocalModel) {
                apiUrl = "http://localhost:11434/v1/chat/completions";
                modelName = "qwen2.5-coder:7b"; // ç¡®ä¿ä½ æœ¬åœ°æœ‰è¿™ä¸ªæ¨¡å‹
                apiKey = "ollama"; // Ollama ä¸éœ€è¦çœŸå® keyï¼Œä½†ä¸ä¼ å¯èƒ½ä¼šæŠ¥é”™
            } else {
                // DeepSeek æ¨¡å¼æ£€æŸ¥ Key
                if (!apiKey || apiKey === "sk-ä½ çš„key" || apiKey.trim() === "") {
                    throw new Error("è¯·å…ˆé…ç½® DEEPSEEK_KEY");
                }
            }

            const headers = new Headers();
            headers.append("Content-Type", "application/json; charset=UTF-8");
            headers.append("Authorization", "Bearer " + apiKey);

            // âœ¨ å¤æ‚åº¦åˆ†æä¸ä½¿ç”¨èŠå¤©å†å²ï¼Œå…¶ä»–æƒ…å†µä½¿ç”¨
            const isComplexityAnalysis = !updateHistory && useJsonMode;
            const requestBody = {
                model: modelName, // ä½¿ç”¨åŠ¨æ€çš„ modelName
                messages: isComplexityAnalysis 
                    ? [{ role: "user", content: prompt }]  // å¤æ‚åº¦åˆ†æä¸ä½¿ç”¨å†å²
                    : [
                        ...chatHistory,
                        { role: "user", content: prompt }
                    ],
                stream: false
            };

            // å¦‚æœè¦æ±‚ JSON æ ¼å¼ï¼Œä½¿ç”¨ response_format
            if (useJsonMode) {
                requestBody.response_format = { type: "json_object" };
                // æ·»åŠ ç³»ç»Ÿæç¤ºç¡®ä¿è¿”å› JSONï¼ˆæ ¹æ® prompt å†…å®¹åˆ¤æ–­æ˜¯å¤æ‚åº¦åˆ†æè¿˜æ˜¯é¢˜ç›®ç”Ÿæˆï¼‰
                const isComplexityAnalysis = prompt.includes("å¤æ‚åº¦") || prompt.includes("æ—¶é—´å¤æ‚åº¦") || prompt.includes("ç©ºé—´å¤æ‚åº¦");
                const systemPrompt = isComplexityAnalysis 
                    ? "ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯é¢è¯•å®˜ï¼Œæ“…é•¿åˆ†æä»£ç å¤æ‚åº¦ã€‚å¿…é¡»ä¸”åªèƒ½è¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚"
                    : "ä½ æ˜¯ä¸€ä¸ªç¼–ç¨‹é¢˜ç›®ç”Ÿæˆå™¨ã€‚å¿…é¡»ä¸”åªèƒ½è¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚";
                requestBody.messages.unshift({
                    role: "system",
                    content: systemPrompt
                });
            } else {
                // æ™®é€šå¯¹è¯æ¨¡å¼ï¼šè¦æ±‚è¿”å› markdown æ ¼å¼ï¼Œä¸è¦è¿”å› JSON
                requestBody.messages.unshift({
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä¸ªè‹æ ¼æ‹‰åº•å¼çš„ç¼–ç¨‹å¯¼å¸ˆï¼Œæ“…é•¿ç”¨å¼•å¯¼æ€§çš„é—®é¢˜å¸®åŠ©å­¦ç”Ÿæ€è€ƒã€‚è¯·ä½¿ç”¨ Markdown æ ¼å¼å›å¤ï¼ˆå¯ä»¥ä½¿ç”¨ä»£ç å—ã€åˆ—è¡¨ã€ç²—ä½“ç­‰æ ¼å¼ï¼‰ï¼Œä½†ä¸è¦è¿”å› JSON æ ¼å¼ã€‚ç›´æ¥è¿”å›æ–‡æœ¬å†…å®¹ï¼Œä¸è¦ä½¿ç”¨ JSON åŒ…è£…ã€‚"
                });
            }

            // âœ¨ ä½¿ç”¨åŠ¨æ€çš„ apiUrl
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const json = await response.json();
            let content = json.choices[0].message.content;
            
            // å¦‚æœä¸æ˜¯ JSON æ¨¡å¼ï¼Œæ£€æŸ¥å¹¶æ¸…ç†å¯èƒ½çš„ JSON åŒ…è£…
            if (!useJsonMode) {
                // å¦‚æœå†…å®¹çœ‹èµ·æ¥åƒæ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå°è¯•æå–å®é™…å†…å®¹
                content = content.trim();
                
                // å°è¯•è§£æ JSONï¼ˆå¦‚æœ AI é”™è¯¯åœ°è¿”å›äº† JSONï¼‰
                try {
                    const parsed = JSON.parse(content);
                    // å¦‚æœè§£ææˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§çš„å­—æ®µ
                    if (parsed.analysis || parsed.content || parsed.message || parsed.text) {
                        // æå–å®é™…å†…å®¹
                        content = parsed.analysis || parsed.content || parsed.message || parsed.text || content;
                    }
                } catch (e) {
                    // ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹
                }
                
                // æ¸…ç†å¯èƒ½çš„ JSON æ ‡è®°å’Œä»£ç å—
                content = content.replace(/^```json\s*/i, '');
                content = content.replace(/^```\s*/, '');
                content = content.replace(/\s*```$/g, '');
                content = content.trim();
            }
            
            // æ›´æ–°èŠå¤©å†å²ï¼ˆåªä¿ç•™æœ€è¿‘5è½®å¯¹è¯ï¼‰ï¼Œä½†å¤æ‚åº¦åˆ†æä¸æ›´æ–°å†å²
            if (updateHistory) {
                chatHistory.push({ role: "user", content: prompt });
                chatHistory.push({ role: "assistant", content: content });
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(-10);
                }
            }

            return content;
        }

        // === è½®è¯¢åç«¯ ===
        setInterval(async () => {
            try {
                const res = await fetch('http://localhost:3000/api/check');
                const data = await res.json();

                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè·³è¿‡
                if (!data) {
                    return;
                }

                // ç¡®ä¿ timestamp æ˜¯æ•°å­—ç±»å‹
                const dataTimestamp = Number(data.timestamp) || 0;
                const currentLastTimestamp = Number(lastTimestamp) || 0;

                // è°ƒè¯•ä¿¡æ¯
                console.log('[ç½‘é¡µç«¯] æ”¶åˆ°æ•°æ®:', {
                    timestamp: dataTimestamp,
                    lastTimestamp: currentLastTimestamp,
                    status: data.status,
                    runtime: data.runtime,
                    memory: data.memory,
                    problemId: data.problemId
                });

                // âœ¨ ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤ï¼ˆé€šè¿‡ timestamp åˆ¤æ–­ï¼‰ï¼Œä¸é™åˆ¶ status
                // åªè¦ä¸æ˜¯ 'read' çŠ¶æ€ä¸”æ—¶é—´æˆ³æ›´æ–°ï¼Œå°±å¤„ç†
                if (dataTimestamp > currentLastTimestamp && data.status !== 'read') {
                    console.log('[ç½‘é¡µç«¯] âœ… å¤„ç†æ–°æäº¤ï¼Œæ—¶é—´æˆ³:', dataTimestamp);
                    lastTimestamp = dataTimestamp;
                    handleNewSubmission(data);
                } else if (data.status === 'read') {
                    console.log('[ç½‘é¡µç«¯] â­ï¸ æäº¤å·²æ ‡è®°ä¸ºå·²è¯»ï¼Œè·³è¿‡');
                } else if (dataTimestamp <= currentLastTimestamp) {
                    console.log('[ç½‘é¡µç«¯] â­ï¸ æ—¶é—´æˆ³æœªæ›´æ–°ï¼ˆ', dataTimestamp, '<=', currentLastTimestamp, 'ï¼‰ï¼Œè·³è¿‡');
                }
            } catch (e) {
                console.error("âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥", e);
            }
        }, 1000);
    </script>
</body>
</html>
