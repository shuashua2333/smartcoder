<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCoder æ™ºèƒ½æ•™å­¦å¹³å°</title>
    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid #0078d4;
        }
        
        h1 { 
            color: #0078d4; 
            font-size: 24px;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
        }

        .left-panel {
            width: 45%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card h2 { 
            margin-bottom: 15px; 
            color: #0078d4;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* çŸ¥è¯†ç‚¹è¾“å…¥åŒº */
        .knowledge-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .knowledge-input-area input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .knowledge-input-area input:focus {
            border-color: #0078d4;
        }

        .knowledge-input-area button {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .knowledge-input-area button:hover {
            background: #005a9e;
        }

        .knowledge-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* é¢˜ç›®å¡ç‰‡ */
        .problem-card {
            flex: 1;
            overflow-y: auto;
        }

        .problem-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .problem-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .problem-description {
            line-height: 1.6;
            color: #444;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .problem-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        button { 
            background: #0078d4; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: 0.3s; 
        }
        button:hover { background: #005a9e; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .status-bar { 
            margin-top: 10px; 
            padding: 10px; 
            border-radius: 4px; 
            background: #e0e0e0; 
            font-size: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #ccc; 
            display: inline-block; 
            margin-right: 5px; 
        }
        .dot.active { 
            background: #28a745; 
            box-shadow: 0 0 5px #28a745; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user {
            background: #0078d4;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            align-self: flex-start;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            align-self: center;
            max-width: 90%;
            font-size: 12px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: border-color 0.3s;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input-area textarea:focus {
            border-color: #0078d4;
        }

        .chat-input-area button {
            padding: 10px 20px;
            align-self: flex-end;
        }

        /* ä»£ç é¢„è§ˆ */
        .code-preview { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 12px; 
            max-height: 150px; 
            overflow: auto; 
            margin-top: 10px; 
            display: none;
            border: 1px solid #333;
        }

        .loading {
            color: #0078d4;
            font-style: italic;
        }

        /* LeetCode é£æ ¼çš„ç»“æœå±•ç¤º */
        .result-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
            max-height: 30vh;
            overflow-y: auto;
        }

        .result-banner {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-banner.accepted {
            background: #0d5635;
            color: #4ade80;
            border: 1px solid #22c55e;
        }

        .result-banner.error {
            background: #7f1d1d;
            color: #f87171;
            border: 1px solid #ef4444;
        }

        .metrics-container {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            padding: 12px;
            background: #252526;
            border-radius: 6px;
        }

        .metric-item {
            flex: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #858585;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
        }

        .metric-unit {
            font-size: 14px;
            color: #858585;
            margin-left: 4px;
        }

        .beat-percentage {
            font-size: 12px;
            color: #4ade80;
            margin-top: 4px;
        }

        .charts-row {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }

        .chart-container {
            flex: 1;
            background: #252526;
            border-radius: 6px;
            padding: 15px;
            min-width: 0; /* ç¡®ä¿ flex å­å…ƒç´ å¯ä»¥æ­£ç¡®æ”¶ç¼© */
        }

        .chart-title {
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        #runtimeChart, #memoryChart {
            width: 100% !important;
            height: 300px !important;
            min-width: 0;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
            .metrics-container {
                flex-direction: column;
                gap: 15px;
            }
            .charts-row {
                flex-direction: column;
            }
            .result-container {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ SmartCoder æ™ºèƒ½ç¼–ç¨‹æ•™å­¦å¹³å°</h1>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ï¼šé¢˜ç›®åŒº -->
        <div class="left-panel">
            <!-- çŸ¥è¯†ç‚¹è¾“å…¥å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸ“š æˆ‘æƒ³å­¦ä¹ </h2>
                <div class="knowledge-input-area">
                    <input 
                        type="text" 
                        id="knowledgeInput" 
                        placeholder="è¾“å…¥çŸ¥è¯†ç‚¹æˆ–æƒ³å­¦çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ•°ç»„ã€æ’åºç®—æ³•ã€åŠ¨æ€è§„åˆ’..."
                        onkeypress="if(event.key==='Enter') generateProblem()"
                    />
                    <button id="generateBtn" onclick="generateProblem()">ğŸ² AI å‡ºé¢˜</button>
                </div>
            </div>

            <!-- é¢˜ç›®å¡ç‰‡ -->
            <div class="card problem-card">
                <div class="problem-title" id="problemTitle">ç­‰å¾…å‡ºé¢˜...</div>
                <div class="problem-id" id="problemId"></div>
                <div class="problem-description" id="problemDescription">
                    è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œç„¶åç‚¹å‡»"AI å‡ºé¢˜"æŒ‰é’®ï¼ŒAI ä¼šä¸ºä½ ç”Ÿæˆç›¸åº”çš„ç¼–ç¨‹é¢˜ç›®ã€‚
                </div>
                <div class="problem-actions">
                    <button id="openVsCodeBtn" onclick="openVsCode()" disabled>ğŸš€ åœ¨ VS Code ä¸­ç¼–ç¨‹</button>
                    <button onclick="generateProblem()">ğŸ”„ æ¢ä¸€é¢˜</button>
                </div>
                <div class="status-bar">
                    <span><span id="sync-dot" class="dot"></span> äº‘ç«¯åŒæ­¥</span>
                    <span id="last-update">ç­‰å¾…è¿æ¥...</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šç»“æœå±•ç¤ºå’Œ AI äº’åŠ¨åŒº -->
        <div class="right-panel">
            <!-- LeetCode é£æ ¼çš„ç»“æœå±•ç¤º -->
            <div class="card result-container" id="resultContainer">
                <div class="result-banner accepted" id="resultBanner">
                    <span>âœ“</span>
                    <span>Accepted</span>
                </div>

                <div class="metrics-container">
                    <div class="metric-item">
                        <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                        <div class="metric-value">
                            <span id="runtimeValue">0</span>
                            <span class="metric-unit">ms</span>
                        </div>
                        <div class="beat-percentage" id="runtimeBeatPct"></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å†…å­˜æ¶ˆè€—</div>
                        <div class="metric-value">
                            <span id="memoryValue">0</span>
                            <span class="metric-unit">MB</span>
                        </div>
                        <div class="beat-percentage" id="memoryBeatPct"></div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <div class="chart-title">è¿è¡Œæ—¶é—´åˆ†å¸ƒ</div>
                        <div id="runtimeChart"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">å†…å­˜ä½¿ç”¨åˆ†å¸ƒ</div>
                        <div id="memoryChart"></div>
                    </div>
                </div>
            </div>

            <div class="card chat-area">
                <h2>ğŸ’¬ AI æ•™å­¦åŠ©æ‰‹</h2>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç¼–ç¨‹å¯¼å¸ˆã€‚ä½ å¯ä»¥ï¼š
                        <br>â€¢ è¾“å…¥çŸ¥è¯†ç‚¹ï¼Œè®©æˆ‘ä¸ºä½ å‡ºé¢˜
                        <br>â€¢ æäº¤ä»£ç åï¼Œæˆ‘ä¼šç»™ä½ è¯¦ç»†åé¦ˆ
                        <br>â€¢ éšæ—¶å‘æˆ‘æé—®
                    </div>
                </div>

                <div id="code-preview" class="code-preview"></div>

                <div class="chat-input-area">
                    <textarea 
                        id="chatInput" 
                        placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–æƒ³è¯´çš„è¯... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
                        onkeydown="handleChatKeyDown(event)"
                    ></textarea>
                    <button onclick="sendChatMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®åŒº ===
        const DEEPSEEK_KEY = "sk-3190a966238e41199f5c7c4ad61f490b";
        const EXTENSION_ID = "smartcoder.smartcoder";

        let lastTimestamp = 0;
        let currentProblem = null;
        let chatHistory = [];
        let runtimeChart = null;
        let memoryChart = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const runtimeChartEl = document.getElementById('runtimeChart');
            const memoryChartEl = document.getElementById('memoryChart');
            
            if (runtimeChartEl) {
                runtimeChart = echarts.init(runtimeChartEl);
            }
            if (memoryChartEl) {
                memoryChart = echarts.init(memoryChartEl);
            }
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿å›¾è¡¨è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                if (runtimeChart) {
                    runtimeChart.resize();
                }
                if (memoryChart) {
                    memoryChart.resize();
                }
            });
        }

        // åˆå§‹åŒ–å›¾è¡¨
        initCharts();

        // === çŸ¥è¯†ç‚¹è¾“å…¥å’ŒAIå‡ºé¢˜ ===
        async function generateProblem() {
            const knowledge = document.getElementById('knowledgeInput').value.trim();
            if (!knowledge) {
                addChatMessage('system', 'è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ æ­£åœ¨å‡ºé¢˜...';

            addChatMessage('user', `æˆ‘æƒ³å­¦ä¹ ï¼š${knowledge}`);

            const prompt = `è¯·ä¸ºå­¦ç”Ÿå­¦ä¹ ä»¥ä¸‹çŸ¥è¯†ç‚¹ç”Ÿæˆä¸€é“ç¼–ç¨‹é¢˜ç›®ã€‚

çŸ¥è¯†ç‚¹ï¼š${knowledge}

è¦æ±‚ï¼š
1. ç”Ÿæˆä¸€é“é€‚åˆåˆå­¦è€…çš„ç¼–ç¨‹é¢˜ç›®
2. é¢˜ç›®åº”è¯¥æ¶µç›–è¯¥çŸ¥è¯†ç‚¹
3. æä¾›æ¸…æ™°çš„é¢˜ç›®æè¿°ï¼ˆåŒ…æ‹¬è¾“å…¥è¾“å‡ºæ ¼å¼ï¼‰
4. é¢˜ç›®éš¾åº¦é€‚ä¸­

âš ï¸ é‡è¦ï¼šå¿…é¡»ä¸”åªèƒ½è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ã€‚
æ ¼å¼ï¼š
{
  "title": "é¢˜ç›®åç§°",
  "id": 101,
  "description": "é¢˜ç›®è¯¦ç»†æè¿°ï¼ˆæ”¯æŒæ¢è¡Œ\\nï¼‰",
  "difficulty": "ç®€å•"
}`;

            try {
                // ä½¿ç”¨ JSON æ¨¡å¼è°ƒç”¨ AI
                const response = await callAIAPI(prompt, true);
                
                // æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—
                let jsonStr = response.trim();
                
                // ç§»é™¤ ```json å’Œ ``` æ ‡è®°
                jsonStr = jsonStr.replace(/^```json\s*/i, '');
                jsonStr = jsonStr.replace(/^```\s*/, '');
                jsonStr = jsonStr.replace(/\s*```$/g, '');
                jsonStr = jsonStr.trim();
                
                // å°è¯•æå– JSON å¯¹è±¡ï¼ˆå¦‚æœ AI åœ¨ JSON å‰åæ·»åŠ äº†æ–‡å­—ï¼‰
                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }
                
                const problemData = JSON.parse(jsonStr);
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (!problemData.title || !problemData.id) {
                    throw new Error('é¢˜ç›®æ•°æ®ä¸å®Œæ•´');
                }
                
                // æ›´æ–°é¢˜ç›®å¡ç‰‡
                currentProblem = problemData;
                document.getElementById('problemTitle').textContent = `é¢˜ç›® ${problemData.id}: ${problemData.title}`;
                document.getElementById('problemId').textContent = `éš¾åº¦ï¼š${problemData.difficulty || 'ä¸­ç­‰'} | ID: ${problemData.id}`;
                document.getElementById('problemDescription').textContent = problemData.description || 'æš‚æ— æè¿°';
                document.getElementById('openVsCodeBtn').disabled = false;

                addChatMessage('ai', `âœ… é¢˜ç›®å·²ç”Ÿæˆï¼\n\n**${problemData.title}**\n\n${problemData.description}\n\nç‚¹å‡»"åœ¨ VS Code ä¸­ç¼–ç¨‹"å¼€å§‹è§£é¢˜å§ï¼`);

            } catch (e) {
                console.error("å‡ºé¢˜å¤±è´¥:", e);
                addChatMessage('ai', `âŒ å‡ºé¢˜å¤±è´¥: ${e.message}\n\nè¯·é‡è¯•æˆ–æ¢ä¸ªçŸ¥è¯†ç‚¹ã€‚å¦‚æœå¤šæ¬¡å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ›´å…·ä½“çš„çŸ¥è¯†ç‚¹æè¿°ï¼ˆä¾‹å¦‚ï¼š"æ•°ç»„æ’åº"è€Œä¸æ˜¯"æ•°ç»„"ï¼‰ã€‚`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ² AI å‡ºé¢˜';
            }
        }

        // === VS Code æ‰“å¼€é¢˜ç›® ===
        function openVsCode() {
            if (!currentProblem) {
                addChatMessage('system', 'è¯·å…ˆç”Ÿæˆé¢˜ç›®ï¼');
                return;
            }

            const title = encodeURIComponent(currentProblem.title);
            const desc = encodeURIComponent(currentProblem.description);
            window.location.href = `vscode://${EXTENSION_ID}/solve?id=${currentProblem.id}&title=${title}&desc=${desc}`;
            
            addChatMessage('system', 'æ­£åœ¨æ‰“å¼€ VS Code...');
        }

        // === èŠå¤©åŠŸèƒ½ ===
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingId = addChatMessage('ai', 'ğŸ¤” æ€è€ƒä¸­...', true);

            try {
                const response = await callAIAPI(message);
                updateChatMessage(loadingId, response);
            } catch (e) {
                console.error("AI å›å¤å¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š${e.message}`);
            }
        }

        function addChatMessage(role, content, isTemp = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random();
            messageDiv.id = messageId;
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (isTemp) {
                messageDiv.classList.add('loading');
            }

            return messageId;
        }

        function updateChatMessage(messageId, newContent) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.classList.remove('loading');
                messageDiv.textContent = newContent;
                // æ”¯æŒ Markdown ç®€å•æ ¼å¼ï¼ˆå¯é€‰ï¼‰
                messageDiv.innerHTML = newContent.replace(/\n/g, '<br>');
            }
        }

        // === ä»£ç æäº¤å¤„ç†ï¼ˆåŒ…å«æ€§èƒ½æ•°æ®ï¼‰ ===
        async function handleNewSubmission(data) {
            document.getElementById('sync-dot').classList.add('active');
            document.getElementById('last-update').textContent = 'æ”¶åˆ°æ–°ä»£ç : ' + new Date().toLocaleTimeString();
            
            const preview = document.getElementById('code-preview');
            preview.style.display = 'block';
            preview.textContent = data.code;

            // åˆ¤æ–­çŠ¶æ€ï¼ˆAccepted æˆ– Errorï¼‰
            const isAccepted = data.runtime >= 0 && data.memory >= 0 && 
                              (!data.output || !data.output.toLowerCase().includes('error') && !data.output.toLowerCase().includes('exception'));
            
            // æ˜¾ç¤º LeetCode é£æ ¼çš„ç»“æœå±•ç¤º
            const resultContainer = document.getElementById('resultContainer');
            const resultBanner = document.getElementById('resultBanner');
            
            if (data.runtime >= 0 && data.memory >= 0) {
                resultContainer.style.display = 'block';
                
                // æ›´æ–°çŠ¶æ€æ¨ªå¹…
                if (isAccepted) {
                    resultBanner.className = 'result-banner accepted';
                    resultBanner.innerHTML = '<span>âœ“</span><span>Accepted</span>';
                } else {
                    resultBanner.className = 'result-banner error';
                    resultBanner.innerHTML = '<span>âœ—</span><span>Error</span>';
                }
                
                // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
                const runtimeValue = data.runtime;
                const memoryValueMB = (data.memory / (1024 * 1024)).toFixed(2);
                
                document.getElementById('runtimeValue').textContent = runtimeValue;
                document.getElementById('memoryValue').textContent = memoryValueMB;
                
                // æ›´æ–°å‡»è´¥ç‡
                const runtimeBeatPctEl = document.getElementById('runtimeBeatPct');
                const memoryBeatPctEl = document.getElementById('memoryBeatPct');
                
                if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                    runtimeBeatPctEl.textContent = `å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·`;
                } else {
                    runtimeBeatPctEl.textContent = '';
                }
                
                if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                    memoryBeatPctEl.textContent = `å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·`;
                } else {
                    memoryBeatPctEl.textContent = '';
                }
                
                // æ¸²æŸ“åˆ†å¸ƒå›¾è¡¨ï¼ˆéœ€è¦ä»åç«¯è·å–å†å²æ•°æ®æˆ–æ¨¡æ‹Ÿæ•°æ®ï¼‰
                await renderDistributionCharts(data);
            } else {
                resultContainer.style.display = 'none';
            }

            // åœ¨èŠå¤©ä¸­ä¹Ÿæ˜¾ç¤ºç®€è¦ä¿¡æ¯
            let perfInfo = '';
            if (data.runtime >= 0 && data.memory >= 0) {
                perfInfo = `\n\nâš¡ **æ€§èƒ½è¯„æµ‹ç»“æœ**\n- è¿è¡Œæ—¶é—´: ${data.runtime}ms`;
                if (data.beatRuntimePct !== null && data.beatRuntimePct !== undefined) {
                    perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·**`;
                }
                perfInfo += `\n- å†…å­˜ä½¿ç”¨: ${(data.memory / 1024).toFixed(2)}KB`;
                if (data.beatMemoryPct !== null && data.beatMemoryPct !== undefined) {
                    perfInfo += ` ğŸ† **å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·**`;
                }
                if (data.output) {
                    perfInfo += `\n\nğŸ“¤ **ç¨‹åºè¾“å‡º:**\n\`\`\`\n${data.output}\n\`\`\``;
                }
            }

            addChatMessage('system', 'ğŸ“¥ æ”¶åˆ°ä»£ç æäº¤' + perfInfo);

            await fetch('http://localhost:3000/api/mark_read', { method: 'POST' });

            const loadingId = addChatMessage('ai', 'ğŸ¤” æ­£åœ¨åˆ†æä½ çš„ä»£ç å’Œæ€§èƒ½æ•°æ®...', true);

            try {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªè‹æ ¼æ‹‰åº•å¼çš„ç¼–ç¨‹å¯¼å¸ˆã€‚å­¦ç”Ÿæäº¤äº†ä»£ç ï¼Œå¹¶æä¾›äº†æ€§èƒ½è¯„æµ‹æ•°æ®å’Œæ’åã€‚
è¯·ä¸è¦ç›´æ¥ç»™å‡ºæ­£ç¡®ç­”æ¡ˆã€‚
ä½ éœ€è¦ï¼š
1. åˆ†æä»£ç é€»è¾‘ã€‚
2. åˆ†ææ€§èƒ½æ•°æ®ï¼ˆè¿è¡Œæ—¶é—´å’Œå†…å­˜ä½¿ç”¨ï¼‰ï¼Œç»™å‡ºä¼˜åŒ–å»ºè®®ã€‚
3. å¦‚æœä»£ç æœ‰é”™ï¼Œç”¨å¼•å¯¼æ€§çš„é—®é¢˜å¯å‘å­¦ç”Ÿï¼ˆä¾‹å¦‚ï¼š"ä½ è€ƒè™‘è¿‡æ•°ç»„ä¸ºç©ºçš„æƒ…å†µå—ï¼Ÿ"ï¼‰ã€‚
4. å¦‚æœä»£ç æ˜¯å¯¹çš„ï¼Œæå‡ºä¼˜åŒ–é—®é¢˜ï¼ˆä¾‹å¦‚ï¼š"ç°åœ¨çš„å¤æ‚åº¦æ˜¯O(n^2)ï¼Œèƒ½ä¼˜åŒ–åˆ°O(n)å—ï¼Ÿ"ï¼‰ã€‚
5. å¦‚æœæä¾›äº†å‡»è´¥ç‡æ•°æ®ï¼Œå¯ä»¥é¼“åŠ±å­¦ç”Ÿæˆ–æå‡ºæ”¹è¿›å»ºè®®ã€‚

å­¦ç”Ÿä»£ç ï¼š
${data.code}

${data.output ? `ç¨‹åºè¾“å‡ºï¼š\n${data.output}\n` : ''}
${data.runtime >= 0 ? `è¿è¡Œæ—¶é—´ï¼š${data.runtime}ms${data.beatRuntimePct !== null && data.beatRuntimePct !== undefined ? ` (å‡»è´¥äº† ${data.beatRuntimePct}% çš„ç”¨æˆ·)` : ''}\n` : ''}
${data.memory >= 0 ? `å†…å­˜ä½¿ç”¨ï¼š${(data.memory / 1024).toFixed(2)}KB${data.beatMemoryPct !== null && data.beatMemoryPct !== undefined ? ` (å‡»è´¥äº† ${data.beatMemoryPct}% çš„ç”¨æˆ·)` : ''}\n` : ''}
å½“å‰é¢˜ç›®ï¼š${currentProblem ? currentProblem.title : 'æœªçŸ¥'}`;

                const feedback = await callAIAPI(prompt);
                updateChatMessage(loadingId, feedback);
            } catch (e) {
                console.error("åˆ†æå¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ åˆ†æå¤±è´¥: ${e.message}`);
            } finally {
                document.getElementById('sync-dot').classList.remove('active');
            }
        }

        // === æ¸²æŸ“åˆ†å¸ƒå›¾è¡¨ ===
        async function renderDistributionCharts(currentData) {
            try {
                // ä»åç«¯è·å–çœŸå®çš„åˆ†å¸ƒæ•°æ®
                const stats = await fetch('http://localhost:3000/api/stats').then(r => r.json()).catch(() => null);
                
                const runtimeValues = stats && stats.runtimeDistribution ? stats.runtimeDistribution : [];
                const memoryValuesMB = stats && stats.memoryDistribution ? stats.memoryDistribution : [];
                
                // å¦‚æœæœ‰å†å²æ•°æ®ï¼Œä½¿ç”¨çœŸå®æ•°æ®ï¼›å¦åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                if (runtimeValues.length === 0 && memoryValuesMB.length === 0) {
                    // æ²¡æœ‰å†å²æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    const runtimeRanges = generateRanges(0, 1000, 50);
                    const memoryRanges = generateRanges(0, 50, 2);
                    const runtimeDistribution = generateMockDistribution(runtimeRanges, currentData.runtime);
                    const memoryDistributionMB = (currentData.memory / (1024 * 1024));
                    const memoryDistribution = generateMockDistribution(memoryRanges, memoryDistributionMB);
                    
                    renderChart(runtimeChart, runtimeRanges, runtimeDistribution, currentData.runtime, 'ms');
                    renderChart(memoryChart, memoryRanges, memoryDistribution, memoryDistributionMB, 'MB');
                } else {
                    // ä½¿ç”¨çœŸå®æ•°æ®
                    const runtimeRanges = calculateRanges(runtimeValues, currentData.runtime, 50);
                    const memoryRanges = calculateRanges(memoryValuesMB, currentData.memory / (1024 * 1024), 2);
                    
                    const runtimeDistribution = calculateDistribution(runtimeValues, runtimeRanges);
                    const memoryDistribution = calculateDistribution(memoryValuesMB, memoryRanges);
                    
                    renderChart(runtimeChart, runtimeRanges, runtimeDistribution, currentData.runtime, 'ms');
                    renderChart(memoryChart, memoryRanges, memoryDistribution, currentData.memory / (1024 * 1024), 'MB');
                }
                
            } catch (e) {
                console.error('æ¸²æŸ“å›¾è¡¨å¤±è´¥:', e);
            }
        }

        // æ ¹æ®æ•°æ®è®¡ç®—åˆç†çš„åŒºé—´
        function calculateRanges(values, currentValue, step) {
            if (values.length === 0) {
                return generateRanges(0, Math.max(currentValue * 2, 100), step);
            }
            
            const allValues = [...values, currentValue];
            const min = Math.floor(Math.min(...allValues) / step) * step;
            const max = Math.ceil(Math.max(...allValues) / step) * step;
            
            return generateRanges(min, max, step);
        }

        // æ ¹æ®çœŸå®æ•°æ®è®¡ç®—åˆ†å¸ƒ
        function calculateDistribution(values, ranges) {
            const distribution = new Array(ranges.length).fill(0);
            
            values.forEach(value => {
                for (let i = 0; i < ranges.length; i++) {
                    const range = ranges[i];
                    const rangeStart = parseInt(range.split('-')[0]);
                    const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                    
                    if (value >= rangeStart && value < rangeEnd) {
                        distribution[i]++;
                        break;
                    }
                }
            });
            
            return distribution;
        }

        // ç”ŸæˆåŒºé—´æ•°ç»„
        function generateRanges(min, max, step) {
            const ranges = [];
            for (let i = min; i < max; i += step) {
                ranges.push(`${i}-${i + step}`);
            }
            ranges.push(`${max}+`);
            return ranges;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†å¸ƒæ•°æ®ï¼ˆå½“æ²¡æœ‰å†å²æ•°æ®æ—¶ä½¿ç”¨ï¼‰
        function generateMockDistribution(ranges, currentValue) {
            const distribution = [];
            for (let i = 0; i < ranges.length; i++) {
                const range = ranges[i];
                const rangeStart = parseInt(range.split('-')[0]);
                const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                
                if (currentValue >= rangeStart && currentValue < rangeEnd) {
                    // å½“å‰å€¼æ‰€åœ¨åŒºé—´ï¼Œè®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„å€¼ï¼ˆæ¨¡æ‹Ÿæœ‰å…¶ä»–ç”¨æˆ·ï¼‰
                    distribution.push(Math.floor(Math.random() * 15) + 3);
                } else {
                    // å…¶ä»–åŒºé—´ï¼Œéšæœºè¾ƒå°çš„å€¼
                    distribution.push(Math.floor(Math.random() * 8));
                }
            }
            return distribution;
        }

        // æ¸²æŸ“å•ä¸ªå›¾è¡¨
        function renderChart(chart, ranges, distribution, currentValue, unit) {
            if (!chart) return;
            
            // æ‰¾åˆ°å½“å‰å€¼æ‰€åœ¨çš„åŒºé—´ç´¢å¼•
            let currentIndex = -1;
            for (let i = 0; i < ranges.length; i++) {
                const range = ranges[i];
                const rangeStart = parseInt(range.split('-')[0]);
                const rangeEnd = range.includes('+') ? Infinity : parseInt(range.split('-')[1]);
                
                if (currentValue >= rangeStart && currentValue < rangeEnd) {
                    currentIndex = i;
                    break;
                }
            }
            
            const option = {
                backgroundColor: 'transparent',
                textStyle: {
                    color: '#ffffff'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    backgroundColor: '#1e1e1e',
                    borderColor: '#3c3c3c',
                    borderWidth: 1,
                    padding: [8, 12],
                    textStyle: {
                        color: '#ffffff',
                        fontSize: 12
                    },
                    formatter: function(params) {
                        const param = params[0];
                        return `${param.name}<br/>ç”¨æˆ·æ•°é‡: ${param.value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '8%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ranges,
                    axisLine: {
                        show: false  // ä¸æ˜¾ç¤ºåæ ‡è½´çº¿
                    },
                    axisTick: {
                        show: false  // ä¸æ˜¾ç¤ºåˆ»åº¦çº¿
                    },
                    axisLabel: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        rotate: 45,
                        fontSize: 11,
                        margin: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'ç”¨æˆ·æ•°é‡',
                    nameTextStyle: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        fontSize: 11,
                        padding: [0, 0, 0, -15]
                    },
                    axisLine: {
                        show: false  // ä¸æ˜¾ç¤ºåæ ‡è½´çº¿
                    },
                    axisTick: {
                        show: false  // ä¸æ˜¾ç¤ºåˆ»åº¦çº¿
                    },
                    axisLabel: {
                        color: '#9ca3af',  // LeetCode æµ…ç°è‰²
                        fontSize: 11
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#3c3c3c',  // æ·±ç°è‰²åˆ†å‰²çº¿
                            type: 'dashed',  // è™šçº¿
                            width: 1
                        }
                    }
                },
                series: [{
                    name: 'ç”¨æˆ·æ•°é‡',
                    type: 'bar',
                    barWidth: '60%',
                    data: distribution.map((value, index) => {
                        if (index === currentIndex) {
                            // é«˜äº®å½“å‰å€¼æ‰€åœ¨åŒºé—´ - ä½¿ç”¨ LeetCode æ ‡å¿—æ€§ç»¿è‰²
                            return {
                                value: value,
                                itemStyle: {
                                    color: '#2cbb5d'  // LeetCode æ ‡å¿—æ€§ç»¿è‰²
                                }
                            };
                        }
                        // å…¶ä»–æŸ±å­ä½¿ç”¨æ·±ç°è‰²
                        return {
                            value: value,
                            itemStyle: {
                                color: '#4b5563'  // æ·±ç°è‰²
                            }
                        };
                    }),
                    label: {
                        show: false
                    },
                    emphasis: {
                        itemStyle: {
                            color: '#2cbb5d'  // é¼ æ ‡æ‚¬åœæ—¶ä¹Ÿæ˜¾ç¤ºç»¿è‰²
                        }
                    }
                }]
            };
            
            chart.setOption(option, true);
            
            // ç¡®ä¿å›¾è¡¨è‡ªé€‚åº”å®¹å™¨å¤§å°
            setTimeout(() => {
                chart.resize();
            }, 100);
        }

        // === AI API è°ƒç”¨ ===
        async function callAIAPI(prompt, useJsonMode = false) {
            if (!DEEPSEEK_KEY || DEEPSEEK_KEY === "sk-ä½ çš„key" || DEEPSEEK_KEY.trim() === "") {
                throw new Error("è¯·å…ˆé…ç½® DEEPSEEK_KEY");
            }

            const apiKey = String(DEEPSEEK_KEY).trim();
            const headers = new Headers();
            headers.append("Content-Type", "application/json; charset=UTF-8");
            headers.append("Authorization", "Bearer " + apiKey);

            const requestBody = {
                model: "deepseek-chat",
                messages: [
                    ...chatHistory,
                    { role: "user", content: prompt }
                ],
                stream: false
            };

            // å¦‚æœè¦æ±‚ JSON æ ¼å¼ï¼Œä½¿ç”¨ response_format
            if (useJsonMode) {
                requestBody.response_format = { type: "json_object" };
                // æ·»åŠ ç³»ç»Ÿæç¤ºç¡®ä¿è¿”å› JSON
                requestBody.messages.unshift({
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä¸ªç¼–ç¨‹é¢˜ç›®ç”Ÿæˆå™¨ã€‚å¿…é¡»ä¸”åªèƒ½è¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚"
                });
            }

            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const json = await response.json();
            const content = json.choices[0].message.content;
            
            // æ›´æ–°èŠå¤©å†å²ï¼ˆåªä¿ç•™æœ€è¿‘5è½®å¯¹è¯ï¼‰
            chatHistory.push({ role: "user", content: prompt });
            chatHistory.push({ role: "assistant", content: content });
            if (chatHistory.length > 10) {
                chatHistory = chatHistory.slice(-10);
            }

            return content;
        }

        // === è½®è¯¢åç«¯ ===
        setInterval(async () => {
            try {
                const res = await fetch('http://localhost:3000/api/check');
                const data = await res.json();

                if (data && data.status === 'pending' && data.timestamp > lastTimestamp) {
                    lastTimestamp = data.timestamp;
                    handleNewSubmission(data);
                }
            } catch (e) {
                console.error("è¿æ¥æœåŠ¡å™¨å¤±è´¥", e);
            }
        }, 1000);
    </script>
</body>
</html>
