<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCoder æ™ºèƒ½æ•™å­¦å¹³å°</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f5f5f5; 
            color: #333; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 2px solid #0078d4;
        }
        
        h1 { 
            color: #0078d4; 
            font-size: 24px;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
        }

        .left-panel {
            width: 45%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .right-panel {
            width: 55%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card h2 { 
            margin-bottom: 15px; 
            color: #0078d4;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* çŸ¥è¯†ç‚¹è¾“å…¥åŒº */
        .knowledge-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .knowledge-input-area input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .knowledge-input-area input:focus {
            border-color: #0078d4;
        }

        .knowledge-input-area button {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .knowledge-input-area button:hover {
            background: #005a9e;
        }

        .knowledge-input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* é¢˜ç›®å¡ç‰‡ */
        .problem-card {
            flex: 1;
            overflow-y: auto;
        }

        .problem-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .problem-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .problem-description {
            line-height: 1.6;
            color: #444;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .problem-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        button { 
            background: #0078d4; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: 0.3s; 
        }
        button:hover { background: #005a9e; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        .status-bar { 
            margin-top: 10px; 
            padding: 10px; 
            border-radius: 4px; 
            background: #e0e0e0; 
            font-size: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #ccc; 
            display: inline-block; 
            margin-right: 5px; 
        }
        .dot.active { 
            background: #28a745; 
            box-shadow: 0 0 5px #28a745; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse { 
            0% { opacity: 1; } 
            50% { opacity: 0.5; } 
            100% { opacity: 1; } 
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.user {
            background: #0078d4;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            align-self: flex-start;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            align-self: center;
            max-width: 90%;
            font-size: 12px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: border-color 0.3s;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input-area textarea:focus {
            border-color: #0078d4;
        }

        .chat-input-area button {
            padding: 10px 20px;
            align-self: flex-end;
        }

        /* ä»£ç é¢„è§ˆ */
        .code-preview { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 12px; 
            max-height: 150px; 
            overflow: auto; 
            margin-top: 10px; 
            display: none;
            border: 1px solid #333;
        }

        .loading {
            color: #0078d4;
            font-style: italic;
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ SmartCoder æ™ºèƒ½ç¼–ç¨‹æ•™å­¦å¹³å°</h1>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ï¼šé¢˜ç›®åŒº -->
        <div class="left-panel">
            <!-- çŸ¥è¯†ç‚¹è¾“å…¥å¡ç‰‡ -->
            <div class="card">
                <h2>ğŸ“š æˆ‘æƒ³å­¦ä¹ </h2>
                <div class="knowledge-input-area">
                    <input 
                        type="text" 
                        id="knowledgeInput" 
                        placeholder="è¾“å…¥çŸ¥è¯†ç‚¹æˆ–æƒ³å­¦çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ•°ç»„ã€æ’åºç®—æ³•ã€åŠ¨æ€è§„åˆ’..."
                        onkeypress="if(event.key==='Enter') generateProblem()"
                    />
                    <button id="generateBtn" onclick="generateProblem()">ğŸ² AI å‡ºé¢˜</button>
                </div>
            </div>

            <!-- é¢˜ç›®å¡ç‰‡ -->
            <div class="card problem-card">
                <div class="problem-title" id="problemTitle">ç­‰å¾…å‡ºé¢˜...</div>
                <div class="problem-id" id="problemId"></div>
                <div class="problem-description" id="problemDescription">
                    è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œç„¶åç‚¹å‡»"AI å‡ºé¢˜"æŒ‰é’®ï¼ŒAI ä¼šä¸ºä½ ç”Ÿæˆç›¸åº”çš„ç¼–ç¨‹é¢˜ç›®ã€‚
                </div>
                <div class="problem-actions">
                    <button id="openVsCodeBtn" onclick="openVsCode()" disabled>ğŸš€ åœ¨ VS Code ä¸­ç¼–ç¨‹</button>
                    <button onclick="generateProblem()">ğŸ”„ æ¢ä¸€é¢˜</button>
                </div>
                <div class="status-bar">
                    <span><span id="sync-dot" class="dot"></span> äº‘ç«¯åŒæ­¥</span>
                    <span id="last-update">ç­‰å¾…è¿æ¥...</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šAI äº’åŠ¨åŒº -->
        <div class="right-panel">
            <div class="card chat-area">
                <h2>ğŸ’¬ AI æ•™å­¦åŠ©æ‰‹</h2>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç¼–ç¨‹å¯¼å¸ˆã€‚ä½ å¯ä»¥ï¼š
                        <br>â€¢ è¾“å…¥çŸ¥è¯†ç‚¹ï¼Œè®©æˆ‘ä¸ºä½ å‡ºé¢˜
                        <br>â€¢ æäº¤ä»£ç åï¼Œæˆ‘ä¼šç»™ä½ è¯¦ç»†åé¦ˆ
                        <br>â€¢ éšæ—¶å‘æˆ‘æé—®
                    </div>
                </div>

                <div id="code-preview" class="code-preview"></div>

                <div class="chat-input-area">
                    <textarea 
                        id="chatInput" 
                        placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–æƒ³è¯´çš„è¯... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
                        onkeydown="handleChatKeyDown(event)"
                    ></textarea>
                    <button onclick="sendChatMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === é…ç½®åŒº ===
        const DEEPSEEK_KEY = "sk-3190a966238e41199f5c7c4ad61f490b";
        const EXTENSION_ID = "smartcoder.smartcoder";

        let lastTimestamp = 0;
        let currentProblem = null;
        let chatHistory = [];

        // === çŸ¥è¯†ç‚¹è¾“å…¥å’ŒAIå‡ºé¢˜ ===
        async function generateProblem() {
            const knowledge = document.getElementById('knowledgeInput').value.trim();
            if (!knowledge) {
                addChatMessage('system', 'è¯·è¾“å…¥ä½ æƒ³å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ æ­£åœ¨å‡ºé¢˜...';

            addChatMessage('user', `æˆ‘æƒ³å­¦ä¹ ï¼š${knowledge}`);

            const prompt = `è¯·ä¸ºå­¦ç”Ÿå­¦ä¹ ä»¥ä¸‹çŸ¥è¯†ç‚¹ç”Ÿæˆä¸€é“ç¼–ç¨‹é¢˜ç›®ã€‚

çŸ¥è¯†ç‚¹ï¼š${knowledge}

è¦æ±‚ï¼š
1. ç”Ÿæˆä¸€é“é€‚åˆåˆå­¦è€…çš„ç¼–ç¨‹é¢˜ç›®
2. é¢˜ç›®åº”è¯¥æ¶µç›–è¯¥çŸ¥è¯†ç‚¹
3. æä¾›æ¸…æ™°çš„é¢˜ç›®æè¿°ï¼ˆåŒ…æ‹¬è¾“å…¥è¾“å‡ºæ ¼å¼ï¼‰
4. é¢˜ç›®éš¾åº¦é€‚ä¸­

âš ï¸ é‡è¦ï¼šå¿…é¡»ä¸”åªèƒ½è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ã€‚
æ ¼å¼ï¼š
{
  "title": "é¢˜ç›®åç§°",
  "id": 101,
  "description": "é¢˜ç›®è¯¦ç»†æè¿°ï¼ˆæ”¯æŒæ¢è¡Œ\\nï¼‰",
  "difficulty": "ç®€å•"
}`;

            try {
                // ä½¿ç”¨ JSON æ¨¡å¼è°ƒç”¨ AI
                const response = await callAIAPI(prompt, true);
                
                // æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—
                let jsonStr = response.trim();
                
                // ç§»é™¤ ```json å’Œ ``` æ ‡è®°
                jsonStr = jsonStr.replace(/^```json\s*/i, '');
                jsonStr = jsonStr.replace(/^```\s*/, '');
                jsonStr = jsonStr.replace(/\s*```$/g, '');
                jsonStr = jsonStr.trim();
                
                // å°è¯•æå– JSON å¯¹è±¡ï¼ˆå¦‚æœ AI åœ¨ JSON å‰åæ·»åŠ äº†æ–‡å­—ï¼‰
                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }
                
                const problemData = JSON.parse(jsonStr);
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (!problemData.title || !problemData.id) {
                    throw new Error('é¢˜ç›®æ•°æ®ä¸å®Œæ•´');
                }
                
                // æ›´æ–°é¢˜ç›®å¡ç‰‡
                currentProblem = problemData;
                document.getElementById('problemTitle').textContent = `é¢˜ç›® ${problemData.id}: ${problemData.title}`;
                document.getElementById('problemId').textContent = `éš¾åº¦ï¼š${problemData.difficulty || 'ä¸­ç­‰'} | ID: ${problemData.id}`;
                document.getElementById('problemDescription').textContent = problemData.description || 'æš‚æ— æè¿°';
                document.getElementById('openVsCodeBtn').disabled = false;

                addChatMessage('ai', `âœ… é¢˜ç›®å·²ç”Ÿæˆï¼\n\n**${problemData.title}**\n\n${problemData.description}\n\nç‚¹å‡»"åœ¨ VS Code ä¸­ç¼–ç¨‹"å¼€å§‹è§£é¢˜å§ï¼`);

            } catch (e) {
                console.error("å‡ºé¢˜å¤±è´¥:", e);
                addChatMessage('ai', `âŒ å‡ºé¢˜å¤±è´¥: ${e.message}\n\nè¯·é‡è¯•æˆ–æ¢ä¸ªçŸ¥è¯†ç‚¹ã€‚å¦‚æœå¤šæ¬¡å¤±è´¥ï¼Œå¯ä»¥å°è¯•æ›´å…·ä½“çš„çŸ¥è¯†ç‚¹æè¿°ï¼ˆä¾‹å¦‚ï¼š"æ•°ç»„æ’åº"è€Œä¸æ˜¯"æ•°ç»„"ï¼‰ã€‚`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ² AI å‡ºé¢˜';
            }
        }

        // === VS Code æ‰“å¼€é¢˜ç›® ===
        function openVsCode() {
            if (!currentProblem) {
                addChatMessage('system', 'è¯·å…ˆç”Ÿæˆé¢˜ç›®ï¼');
                return;
            }

            const title = encodeURIComponent(currentProblem.title);
            const desc = encodeURIComponent(currentProblem.description);
            window.location.href = `vscode://${EXTENSION_ID}/solve?id=${currentProblem.id}&title=${title}&desc=${desc}`;
            
            addChatMessage('system', 'æ­£åœ¨æ‰“å¼€ VS Code...');
        }

        // === èŠå¤©åŠŸèƒ½ ===
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingId = addChatMessage('ai', 'ğŸ¤” æ€è€ƒä¸­...', true);

            try {
                const response = await callAIAPI(message);
                updateChatMessage(loadingId, response);
            } catch (e) {
                console.error("AI å›å¤å¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š${e.message}`);
            }
        }

        function addChatMessage(role, content, isTemp = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random();
            messageDiv.id = messageId;
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (isTemp) {
                messageDiv.classList.add('loading');
            }

            return messageId;
        }

        function updateChatMessage(messageId, newContent) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                messageDiv.classList.remove('loading');
                messageDiv.textContent = newContent;
                // æ”¯æŒ Markdown ç®€å•æ ¼å¼ï¼ˆå¯é€‰ï¼‰
                messageDiv.innerHTML = newContent.replace(/\n/g, '<br>');
            }
        }

        // === ä»£ç æäº¤å¤„ç† ===
        async function handleNewSubmission(data) {
            document.getElementById('sync-dot').classList.add('active');
            document.getElementById('last-update').textContent = 'æ”¶åˆ°æ–°ä»£ç : ' + new Date().toLocaleTimeString();
            
            const preview = document.getElementById('code-preview');
            preview.style.display = 'block';
            preview.textContent = data.code;

            addChatMessage('system', 'ğŸ“¥ æ”¶åˆ°ä»£ç æäº¤ï¼Œæ­£åœ¨åˆ†æ...');

            await fetch('http://localhost:3000/api/mark_read', { method: 'POST' });

            const loadingId = addChatMessage('ai', 'ğŸ¤” æ­£åœ¨åˆ†æä½ çš„ä»£ç ...', true);

            try {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªè‹æ ¼æ‹‰åº•å¼çš„ç¼–ç¨‹å¯¼å¸ˆã€‚å­¦ç”Ÿæäº¤äº†ä»£ç ã€‚
è¯·ä¸è¦ç›´æ¥ç»™å‡ºæ­£ç¡®ç­”æ¡ˆã€‚
ä½ éœ€è¦ï¼š
1. åˆ†æä»£ç é€»è¾‘ã€‚
2. å¦‚æœä»£ç æœ‰é”™ï¼Œç”¨å¼•å¯¼æ€§çš„é—®é¢˜å¯å‘å­¦ç”Ÿï¼ˆä¾‹å¦‚ï¼š"ä½ è€ƒè™‘è¿‡æ•°ç»„ä¸ºç©ºçš„æƒ…å†µå—ï¼Ÿ"ï¼‰ã€‚
3. å¦‚æœä»£ç æ˜¯å¯¹çš„ï¼Œæå‡ºä¼˜åŒ–é—®é¢˜ï¼ˆä¾‹å¦‚ï¼š"ç°åœ¨çš„å¤æ‚åº¦æ˜¯O(n^2)ï¼Œèƒ½ä¼˜åŒ–åˆ°O(n)å—ï¼Ÿ"ï¼‰ã€‚

å­¦ç”Ÿä»£ç ï¼š
${data.code}

å½“å‰é¢˜ç›®ï¼š${currentProblem ? currentProblem.title : 'æœªçŸ¥'}`;

                const feedback = await callAIAPI(prompt);
                updateChatMessage(loadingId, feedback);
            } catch (e) {
                console.error("åˆ†æå¤±è´¥:", e);
                updateChatMessage(loadingId, `âŒ åˆ†æå¤±è´¥: ${e.message}`);
            } finally {
                document.getElementById('sync-dot').classList.remove('active');
            }
        }

        // === AI API è°ƒç”¨ ===
        async function callAIAPI(prompt, useJsonMode = false) {
            if (!DEEPSEEK_KEY || DEEPSEEK_KEY === "sk-ä½ çš„key" || DEEPSEEK_KEY.trim() === "") {
                throw new Error("è¯·å…ˆé…ç½® DEEPSEEK_KEY");
            }

            const apiKey = String(DEEPSEEK_KEY).trim();
            const headers = new Headers();
            headers.append("Content-Type", "application/json; charset=UTF-8");
            headers.append("Authorization", "Bearer " + apiKey);

            const requestBody = {
                model: "deepseek-chat",
                messages: [
                    ...chatHistory,
                    { role: "user", content: prompt }
                ],
                stream: false
            };

            // å¦‚æœè¦æ±‚ JSON æ ¼å¼ï¼Œä½¿ç”¨ response_format
            if (useJsonMode) {
                requestBody.response_format = { type: "json_object" };
                // æ·»åŠ ç³»ç»Ÿæç¤ºç¡®ä¿è¿”å› JSON
                requestBody.messages.unshift({
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä¸ªç¼–ç¨‹é¢˜ç›®ç”Ÿæˆå™¨ã€‚å¿…é¡»ä¸”åªèƒ½è¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ markdown ä»£ç å—åŒ…è£¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—ã€‚"
                });
            }

            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const json = await response.json();
            const content = json.choices[0].message.content;
            
            // æ›´æ–°èŠå¤©å†å²ï¼ˆåªä¿ç•™æœ€è¿‘5è½®å¯¹è¯ï¼‰
            chatHistory.push({ role: "user", content: prompt });
            chatHistory.push({ role: "assistant", content: content });
            if (chatHistory.length > 10) {
                chatHistory = chatHistory.slice(-10);
            }

            return content;
        }

        // === è½®è¯¢åç«¯ ===
        setInterval(async () => {
            try {
                const res = await fetch('http://localhost:3000/api/check');
                const data = await res.json();

                if (data && data.status === 'pending' && data.timestamp > lastTimestamp) {
                    lastTimestamp = data.timestamp;
                    handleNewSubmission(data);
                }
            } catch (e) {
                console.error("è¿æ¥æœåŠ¡å™¨å¤±è´¥", e);
            }
        }, 1000);
    </script>
</body>
</html>
